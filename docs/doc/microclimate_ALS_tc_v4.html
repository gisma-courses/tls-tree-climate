<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Reudenbach">
<meta name="dcterms.date" content="2025-07-29">

<title>ENVI-met 3DPLANTs from ALS Data – Envi_Met TLS-tree-climate</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../doc/new_utils2.html" rel="next">
<link href="../doc/tls_v1_2.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-b53751a350365c71b6c909e95f209ed1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-0a8fc4914ce287db04f51fd4332c87fe.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-557e0aaec44ac059c2cae0be7f7b926a.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../css/styles.css">
<meta property="og:title" content="ENVI-met 3DPLANTs from ALS Data – Envi_Met TLS-tree-climate">
<meta property="og:description" content="">
<meta property="og:site_name" content="Envi_Met TLS-tree-climate">
<meta name="twitter:title" content="ENVI-met 3DPLANTs from ALS Data – Envi_Met TLS-tree-climate">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@gisma">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logooil.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Envi_Met TLS-tree-climate</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">ENVI-met 3DPLANTs from ALS Data</h1>
        </a>     
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
 <span class="menu-text">Models Evaluation</span>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluation of Atmosphere–Vegetation Interaction Models</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
 <span class="menu-text">Hands On</span>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/fluxes_corrected.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Energy Flux Analysis from Energy Balance Station</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/tls_v1_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using leaf area density (LAD) from TLS data in ENVI-met for 3D plants</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/microclimate_ALS_tc_v4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">ENVI-met 3DPLANTs from ALS Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/new_utils2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Function &amp; Workflow Reference: LAD and ALS Processing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/osm2envi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">QGIS ENVIMET Preprocessor</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../doc/treespecies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tree Species Classification Cleaning with OTB and Terra</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#workflow-overview" id="toc-workflow-overview" class="nav-link" data-scroll-target="#workflow-overview">Workflow Overview</a>
  <ul class="collapse">
  <li><a href="#setup-and-configuration" id="toc-setup-and-configuration" class="nav-link" data-scroll-target="#setup-and-configuration">Setup and Configuration</a></li>
  <li><a href="#als-preprocessing-and-normalization" id="toc-als-preprocessing-and-normalization" class="nav-link" data-scroll-target="#als-preprocessing-and-normalization">ALS Preprocessing and Normalization</a></li>
  <li><a href="#terrain-and-canopy-metrics" id="toc-terrain-and-canopy-metrics" class="nav-link" data-scroll-target="#terrain-and-canopy-metrics">Terrain and Canopy Metrics</a></li>
  <li><a href="#voxelization-and-lad-calculation" id="toc-voxelization-and-lad-calculation" class="nav-link" data-scroll-target="#voxelization-and-lad-calculation">Voxelization and LAD Calculation</a></li>
  </ul></li>
  <li><a href="#structural-and-ecological-metrics" id="toc-structural-and-ecological-metrics" class="nav-link" data-scroll-target="#structural-and-ecological-metrics">Structural and Ecological Metrics</a>
  <ul class="collapse">
  <li><a href="#clustering-and-profile-aggregation" id="toc-clustering-and-profile-aggregation" class="nav-link" data-scroll-target="#clustering-and-profile-aggregation">Clustering and Profile Aggregation</a></li>
  </ul></li>
  <li><a href="#trait-assignment-and-xml-export" id="toc-trait-assignment-and-xml-export" class="nav-link" data-scroll-target="#trait-assignment-and-xml-export">Trait Assignment and XML Export</a></li>
  <li><a href="#export-tree-locations" id="toc-export-tree-locations" class="nav-link" data-scroll-target="#export-tree-locations">Export Tree Locations</a></li>
  <li><a href="#weak-points" id="toc-weak-points" class="nav-link" data-scroll-target="#weak-points">Weak Points</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#source-code" id="toc-source-code" class="nav-link" data-scroll-target="#source-code">Source Code</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/gisma-courses/TLS-tree-climate/edit/main/doc/microclimate_ALS_tc_v4.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/gisma-courses/TLS-tree-climate/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">ENVI-met 3DPLANTs from ALS Data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Reudenbach </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 29, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This tutorial guides you through the complete workflow to derive vegetation structure information from Airborne Laser Scanning (ALS) data and export it into a format compatible with ENVI-met’s 3DPLANT system.</p>
<p>We cover:</p>
<ul>
<li>Merging and preprocessing ALS point clouds</li>
<li>Generating digital terrain and surface models</li>
<li>Voxelizing ALS data and calculating Leaf Area Density (LAD)</li>
<li>Deriving ecological and structural metrics</li>
<li>Clustering tree profiles into generalized types</li>
<li>Exporting synthetic 3D tree definitions (.pld XML) and their locations (.gpkg)</li>
</ul>
</section>
<section id="workflow-overview" class="level2">
<h2 class="anchored" data-anchor-id="workflow-overview">Workflow Overview</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
  A[LAS tiles] --&gt; B[Merge + Normalize]
  B --&gt; C[DEM, CHM, DSM]
  C --&gt; D[Topographic indices]
  B --&gt; E[Voxelize + LAD via Beer–Lambert]
  D --&gt; F[Add species + topography to LAD]
  E --&gt; F
  F --&gt; G[PCA + NbClust]
  G --&gt; H[KMeans clustering]
  H --&gt; I[Aggregate profiles]
  I --&gt; J[Compute traits]
  J --&gt; K[Export .pld XML]
  J --&gt; L[Export GPKG positions]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<section id="setup-and-configuration" class="level3">
<h3 class="anchored" data-anchor-id="setup-and-configuration">Setup and Configuration</h3>
<p>We begin by loading all required libraries and defining key input/output paths and parameters.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary R packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lidR)       <span class="co"># for LiDAR handling</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)      <span class="co"># for raster operations</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)      <span class="co"># data wrangling</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)      <span class="co"># reshaping</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)         <span class="co"># spatial data (simple features)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)       <span class="co"># file path handling</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(XML)        <span class="co"># export to ENVI-met XML</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(clusternomics) <span class="co"># clustering</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also define which species classes are considered valid and load a species raster map for later assignment.</p>
</section>
<section id="als-preprocessing-and-normalization" class="level3">
<h3 class="anchored" data-anchor-id="als-preprocessing-and-normalization">ALS Preprocessing and Normalization</h3>
<p>First, the LAS tiles are merged and their heights normalized using a DEM derived from the ground classification.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>las_fn <span class="ot">&lt;-</span> <span class="fu">merge_las_tiles</span>(...)  <span class="co"># Merges all LAS tiles into one</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(las_fn)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">classify_ground</span>(las, <span class="fu">csf</span>(...))  <span class="co"># Adaptive Cloth Simulation Filter</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The point cloud is then normalized to height above ground using <code>normalize_height()</code>.</p>
</section>
<section id="terrain-and-canopy-metrics" class="level3">
<h3 class="anchored" data-anchor-id="terrain-and-canopy-metrics">Terrain and Canopy Metrics</h3>
<p>We generate various raster layers:</p>
<ul>
<li><strong>DEM</strong> – Digital Elevation Model</li>
<li><strong>DSM</strong> – Digital Surface Model (top of canopy)</li>
<li><strong>CHM</strong> – Canopy Height Model (DSM – DEM)</li>
<li><strong>Slope</strong>, <strong>Aspect</strong>, and <strong>TPI</strong> – Topographic descriptors</li>
</ul>
<p>These are later used to enrich each voxel with its spatial context.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">terrain</span>(dem, <span class="st">"slope"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>CHM <span class="ot">&lt;-</span> DSM <span class="sc">-</span> DEM</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="voxelization-and-lad-calculation" class="level3">
<h3 class="anchored" data-anchor-id="voxelization-and-lad-calculation">Voxelization and LAD Calculation</h3>
<p>The normalized ALS cloud is converted to voxels and LAD profiles are derived using a Beer–Lambert approach:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>voxels <span class="ot">&lt;-</span> <span class="fu">preprocess_voxels</span>(las_norm, res_xy, res_z)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>lad_df <span class="ot">&lt;-</span> <span class="fu">convert_to_LAD_beer</span>(voxels, <span class="at">grainsize =</span> res_z, <span class="at">k =</span> <span class="fl">0.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Explanation</strong>: The Beer–Lambert law models LAD from voxel pulse counts as an exponential decay of light through vegetation. Each voxel contributes to the vertical profile based on its pulse return density and assumed extinction coefficient.</p>
<section id="advanced-implementation-details" class="level4">
<h4 class="anchored" data-anchor-id="advanced-implementation-details">Advanced Implementation Details</h4>
<p>This pipeline uses a highly optimized voxel engine that pre-aggregates point returns into vertical bins based on user-defined voxel height (<code>res_z</code>).</p>
<p>The <code>convert_to_LAD_beer()</code> function applies:</p>
<ul>
<li><p><strong>Normalization</strong> by the maximum point count per column (to estimate occlusion probability)</p></li>
<li><p><strong>Beer–Lambert transformation</strong>:</p>
<p><span class="math display">\[\text{LAD}_i = -\frac{\ln(1 - \frac{N_i}{N_{\max}})}{k \cdot \Delta z}\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(N_i\)</span> = point returns in voxel <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(N_{\max}\)</span> = max returns in vertical column</li>
<li><span class="math inline">\(k\)</span> = extinction coefficient (typically 0.3–0.5)</li>
<li><span class="math inline">\(\Delta z\)</span> = voxel height (e.g.&nbsp;2 m)</li>
</ul></li>
<li><p><strong>Clipping to physical LAD limits</strong>: optional thresholds (e.g., LAD_min = 0.05, LAD_max = 3.0)</p></li>
<li><p><strong>Optional scaling</strong>: using a correction factor (<code>scale_factor</code>) for vegetation type</p></li>
</ul>
<p>This approach is robust across canopy densities and avoids bias from heterogeneous ALS sampling.</p>
</section>
<section id="spatial-enrichment" class="level4">
<h4 class="anchored" data-anchor-id="spatial-enrichment">Spatial Enrichment</h4>
<p>Each voxel column is enriched with values from the terrain metrics (elevation, slope, CHM, etc.) and species raster via buffered spatial extraction using the <code>exactextractr</code> package.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>elev <span class="ot">&lt;-</span> <span class="fu">exact_extract</span>(dem, <span class="fu">st_buffer</span>(...))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Note</strong>: We use small buffers to ensure overlap with raster cells, especially for coarse resolutions or near-boundary voxels.</p>
</section>
</section>
</section>
<section id="structural-and-ecological-metrics" class="level2">
<h2 class="anchored" data-anchor-id="structural-and-ecological-metrics">Structural and Ecological Metrics</h2>
<p>From the LAD profiles, we derive additional vegetation structure descriptors:</p>
<ul>
<li><strong>LAD_mean / LAD_max</strong> – Central tendency</li>
<li><strong>Skewness / Kurtosis</strong> – Shape of vertical distribution</li>
<li><strong>Entropy</strong> – Evenness / complexity of LAD</li>
<li><strong>Canopy Cover</strong>, <strong>Gap Fraction</strong> – Occupancy of upper and lower canopy</li>
<li><strong>Vertical Evenness</strong> – Shannon diversity of vertical distribution</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_mean <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowMeans2</span>(lad_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Interpretation</strong>: These metrics help characterize different plant types and are key inputs to the clustering process.</p>
<section id="clustering-and-profile-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="clustering-and-profile-aggregation">Clustering and Profile Aggregation</h3>
<p>We sample the LAD space, reduce dimensionality via Principal Component Analysis (PCA), and use NbClust to find the optimal number of clusters. These clusters represent generalized tree types for ENVI-met.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pca_res <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(sample_data, <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="fu">NbClust</span>(...)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>km <span class="ot">&lt;-</span> <span class="fu">KMeans_arma</span>(...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="pca-concept-and-purpose" class="level4">
<h4 class="anchored" data-anchor-id="pca-concept-and-purpose">PCA Concept and Purpose</h4>
<p>PCA transforms the original high-dimensional LAD profile into a set of orthogonal axes (principal components) that capture the greatest variance in the data. This has several advantages:</p>
<ul>
<li><strong>Noise reduction</strong>: Removes minor variance and unstable features</li>
<li><strong>Interpretability</strong>: Principal axes often reflect dominant structural traits</li>
<li><strong>Efficiency</strong>: Downsamples high-dimensional LAD vectors to fewer axes (e.g., 5–10 PCs)</li>
<li><strong>Clustering stability</strong>: Improves separation of groups in Euclidean space</li>
</ul>
<p>We determine the number of components by examining explained variance and selecting a cutoff (e.g., 80%). NbClust is then applied to the PCA-reduced data to identify the optimal number of vegetation types (clusters).</p>
</section>
</section>
</section>
<section id="trait-assignment-and-xml-export" class="level2">
<h2 class="anchored" data-anchor-id="trait-assignment-and-xml-export">Trait Assignment and XML Export</h2>
<p>For each cluster, we assign:</p>
<ul>
<li><strong>Species name</strong> via majority vote</li>
<li><strong>LeafThickness</strong> via lookup table</li>
<li><strong>LAI</strong>, <strong>Crown height</strong>, <strong>Max LAD</strong>, <strong>Roughness length</strong> via structural stats</li>
</ul>
<p>Then export to <code>.pld</code> (ENVI-met XML format):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">export_lad_to_envimet_p3d</span>(lad_df, <span class="at">file_out =</span> ..., <span class="at">trait_df =</span> ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Note</strong>: Ensure that ENVIMET_ID is uniquely assigned and used for mapping in both XML and spatial files.</p>
</section>
<section id="export-tree-locations" class="level2">
<h2 class="anchored" data-anchor-id="export-tree-locations">Export Tree Locations</h2>
<p>The x/y locations of all LAD columns are exported to a GeoPackage with their cluster ID (<code>ENVIMET_ID</code>) for domain placement in ENVI-met.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(sf_points, output_gpkg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Tip</strong>: These point geometries can be directly imported into ENVI-met Spaces or Generator.</p>
</section>
<section id="weak-points" class="level1">
<h1>Weak Points</h1>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Issue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>preprocess_voxels()</code></td>
<td>Assumes normalized input; no fallback or validation</td>
</tr>
<tr class="even">
<td><code>convert_to_LAD_beer()</code></td>
<td>Max normalization sensitive to outliers, bias in sparse canopies</td>
</tr>
<tr class="odd">
<td>Trait mapping</td>
<td><code>LeafThickness</code> hard-coded; no fallback if species unknown</td>
</tr>
<tr class="even">
<td>Memory</td>
<td><code>lad_matrix</code>, <code>NbClust</code>, full CHM are RAM-intensive steps</td>
</tr>
<tr class="odd">
<td>XML export</td>
<td><code>.pld</code> profiles rely on rigid class–species mapping, not trait-driven</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This pipeline generates realistic, location-aware synthetic vegetation objects based on ALS-derived LAD profiles i.e.&nbsp;the structural types. The final <code>.pld</code> and <code>.gpkg</code> can be directly used for the QGIS ENVI-met plugin.:</p>
<ul>
<li>Replacing max-based LAD normalization with transmittance calibration</li>
<li>Incorporating TLS-derived QSM traits</li>
<li>Using functional trait databases for <code>LeafThickness</code> and roughness</li>
<li>Validating <code>.pld</code> export by reverse simulation</li>
</ul>
<p>The current pipeline serves as a robust foundation for vegetation–atmosphere model coupling using real-world ALS data.</p>
</section>
<section id="source-code" class="level1">
<h1>Source Code</h1>
<ul>
<li><a href="../src/microclimate_ALS_tc_v4.R">Download microclimate_ALS_tc_v4.R</a></li>
<li><a href="../src/new_utils.R">Download new_utils.R</a></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Source Code">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Source Code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="functions-from-new_utils.r" class="level2">
<h2 class="anchored" data-anchor-id="functions-from-new_utils.r">Functions from <code>new_utils.R</code></h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#' Suggest Optimal Number of Principal Components</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function analyzes a PCA object to determine the recommended number of </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' principal components (PCs) to retain, using three common criteria:</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cumulative explained variance (threshold-based)</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Kaiser criterion (eigenvalue &gt; 1)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Elbow method (first minimum of successive variance drops)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' Optionally, a diagnostic plot (scree and cumulative variance) is shown.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pca_obj A PCA object returned by [prcomp()] or similar. Must contain `$sdev`.</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param variance_cutoff Numeric; cumulative variance threshold for selecting PCs </span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'                        (default is 0.8 = 80% explained variance).</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param plot Logical; if `TRUE`, a scree plot and cumulative variance plot are displayed.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list containing:</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' \describe{</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{n_pcs}{Number of PCs recommended based on the variance threshold.}</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{explained_variance}{Number of PCs needed to reach the variance cutoff.}</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{kaiser}{Number of PCs with eigenvalue &gt; 1 (Kaiser criterion).}</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{elbow}{Position of elbow point (first minimal drop in explained variance).}</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{info_table}{A summary table showing the values for each criterion.}</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Cumulative Variance Threshold**: Retain the smallest number of components such that</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the cumulative proportion of explained variance meets or exceeds `variance_cutoff`.</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Kaiser Criterion**: Retain all components with eigenvalues greater than 1. Assumes</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co">#'   data has been standardized (mean-centered and scaled). See Kaiser (1960).</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Elbow Method**: Finds the index where the decrease in explained variance is smallest,</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">#'   i.e., where the "knee" or "elbow" appears in the scree plot.</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' @references</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Jolliffe, I. T. (2002). *Principal Component Analysis*. Springer Series in Statistics.</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Kaiser, H. F. (1960). The application of electronic computers to factor analysis.</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co">#'   *Educational and Psychological Measurement*, 20(1), 141–151.</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cattell, R. B. (1966). The scree test for the number of factors. *Multivariate Behavioral Research*, 1(2), 245–276.</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co">#' pca &lt;- prcomp(USArrests, scale. = TRUE)</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="co">#' suggest_n_pcs(pca, variance_cutoff = 0.9)</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>suggest_n_pcs <span class="ot">&lt;-</span> <span class="cf">function</span>(pca_obj, <span class="at">variance_cutoff =</span> <span class="fl">0.8</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract standard deviations of the principal components</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  std_dev <span class="ot">&lt;-</span> pca_obj<span class="sc">$</span>sdev</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute proportion of variance explained by each PC</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  var_explained <span class="ot">&lt;-</span> std_dev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(std_dev<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute cumulative explained variance</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  cum_var_explained <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(var_explained)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Criterion 1: Number of components needed to reach variance_cutoff</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>  n_var <span class="ot">&lt;-</span> <span class="fu">which</span>(cum_var_explained <span class="sc">&gt;=</span> variance_cutoff)[<span class="dv">1</span>]</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Criterion 2: Kaiser criterion – eigenvalue &gt; 1</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>  eigenvalues <span class="ot">&lt;-</span> std_dev<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>  n_kaiser <span class="ot">&lt;-</span> <span class="fu">sum</span>(eigenvalues <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Criterion 3: Elbow method – where decrease in explained variance flattens</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>  diffs <span class="ot">&lt;-</span> <span class="fu">diff</span>(var_explained)</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>  elbow <span class="ot">&lt;-</span> <span class="fu">which.min</span>(diffs)[<span class="dv">1</span>]</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assemble criterion comparison table</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  info_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">Criterion =</span> <span class="fu">c</span>(<span class="st">"Variance Cutoff"</span>, <span class="st">"Kaiser Criterion"</span>, <span class="st">"Elbow Method"</span>),</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">Num_Components =</span> <span class="fu">c</span>(n_var, n_kaiser, elbow),</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">Cumulative_Explained_Variance =</span> <span class="fu">c</span>(</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(cum_var_explained[n_var], <span class="dv">3</span>),</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(cum_var_explained[n_kaiser], <span class="dv">3</span>),</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(cum_var_explained[elbow], <span class="dv">3</span>)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final recommendation is based on variance_cutoff only (can be modified as needed)</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>  n_final <span class="ot">&lt;-</span> n_var</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print summary</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"📊 Summary of PCA Component Selection Criteria:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(info_table, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">✅ Recommended number of PCs (based on variance_cutoff ="</span>, variance_cutoff, <span class="st">"):"</span>, n_final, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional plots</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (plot) {</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scree plot: individual variance explained</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(var_explained, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"steelblue"</span>,</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab =</span> <span class="st">"Component"</span>, <span class="at">ylab =</span> <span class="st">"Explained Variance"</span>,</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">"Scree Plot"</span>)</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)     <span class="co"># Kaiser line</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> elbow, <span class="at">col =</span> <span class="st">"darkgreen"</span>, <span class="at">lty =</span> <span class="dv">3</span>)  <span class="co"># Elbow marker</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Kaiser (λ &gt; 1)"</span>, <span class="st">"Elbow"</span>),</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"darkgreen"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative variance plot</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cum_var_explained, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"darkorange"</span>,</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab =</span> <span class="st">"Component"</span>, <span class="at">ylab =</span> <span class="st">"Cumulative Variance"</span>,</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">"Cumulative Explained Variance"</span>)</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> variance_cutoff, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> n_var, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Cutoff"</span>, <span class="st">"Selected Components"</span>),</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))  <span class="co"># reset plotting layout</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return results silently for use in pipelines</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pcs =</span> n_final,</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">explained_variance =</span> n_var,</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">kaiser =</span> n_kaiser,</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow =</span> elbow,</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">info_table =</span> info_table</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="co">#' Split Z Coordinates into Vertical Slices and Count Points per Slice</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function takes a vector of Z-coordinates (heights) and bins them into</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a><span class="co">#' 1-meter horizontal slices. It returns the count of points in each slice, ensuring that</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="co">#' all slices from 0 to `maxZ` are represented, even if some slices have zero points.</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param Z A numeric vector of Z coordinates (e.g., heights of LiDAR points in meters).</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param maxZ Integer; the maximum height to consider (defines the highest slice boundary).</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A named list containing point counts per 1-meter height slice. The names are</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a><span class="co">#' formatted for clarity (e.g., `"ground_0_1m"`, `"pulses_1_2m"`, …).</span></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a><span class="co">#' - This is a foundational step in computing vertical vegetation structure such as</span></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Leaf Area Density (LAD) profiles.</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a><span class="co">#' - The slicing assumes a 1-meter vertical resolution and bins by floor(Z).</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Empty slices (no points) are included with count 0 to preserve structure for later matrix assembly.</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a><span class="co">#' z_vals &lt;- runif(1000, 0, 20)</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a><span class="co">#' pointsByZSlice(z_vals, maxZ = 20)</span></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>pointsByZSlice <span class="ot">&lt;-</span> <span class="cf">function</span>(Z, maxZ) {</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Floor Z-values to get integer bin index (0-based)</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>  heightSlices <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(Z)</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data.table for potential grouping (not used further here)</span></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>  zSlice <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">data.table</span>(<span class="at">Z =</span> Z, <span class="at">heightSlices =</span> heightSlices)</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Count number of points per height slice using base aggregate</span></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>  sliceCount <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">aggregate</span>(<span class="fu">list</span>(<span class="at">V1 =</span> Z), <span class="fu">list</span>(<span class="at">heightSlices =</span> heightSlices), length)</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>  sliceCount<span class="sc">$</span>V1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(sliceCount<span class="sc">$</span>V1)  <span class="co"># Ensure numeric (not integer or factor)</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure all expected slice bins [0, maxZ] exist (fill with 0 if missing)</span></span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>  colRange <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>maxZ</span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>  missing <span class="ot">&lt;-</span> colRange[<span class="sc">!</span>colRange <span class="sc">%in%</span> sliceCount<span class="sc">$</span>heightSlices]</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>    fill <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">heightSlices =</span> missing, <span class="at">V1 =</span> <span class="fu">as.numeric</span>(<span class="dv">0</span>))</span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>    sliceCount <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sliceCount, fill)</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Order slices from bottom to top</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>  sliceCount <span class="ot">&lt;-</span> sliceCount[<span class="fu">order</span>(sliceCount<span class="sc">$</span>heightSlices), ]</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create readable column names for each slice</span></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>  colNames <span class="ot">&lt;-</span> <span class="fu">as.character</span>(sliceCount<span class="sc">$</span>heightSlices)</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>  colNames[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"ground_0_1m"</span>  <span class="co"># Name for the lowest bin</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>  colNames[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"pulses_"</span>, sliceCount<span class="sc">$</span>heightSlices[<span class="sc">-</span><span class="dv">1</span>], <span class="st">"_"</span>, sliceCount<span class="sc">$</span>heightSlices[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>, <span class="st">"m"</span>)</span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create named list of metrics</span></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>  metrics[colNames] <span class="ot">&lt;-</span> sliceCount<span class="sc">$</span>V1</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(metrics)</span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a><span class="co">#' Recommend DEM Interpolation Method Based on Ground Point Quality</span></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function analyzes a LAS object or LAS file and recommends an appropriate interpolation</span></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a><span class="co">#' method (`tin()`, `knnidw()`, or `kriging()`) for `lidR::rasterize_terrain()` based on</span></span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a><span class="co">#' ground point density, ratio, and nearest-neighbor distance.</span></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param las A LAS object or character path to a .las/.laz file.</span></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res Numeric. Raster resolution (in meters) for ground point density estimation. Default is 1.</span></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param verbose Logical. If TRUE, prints diagnostic information. Default is TRUE.</span></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A character string with the recommended interpolation function (e.g., `"tin()"`)</span></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function implements a rule-based scoring system to select an appropriate terrain</span></span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a><span class="co">#' interpolation algorithm for `lidR::rasterize_terrain()`. The recommendation is based on:</span></span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a><span class="co">#' \itemize{</span></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item Ground point ratio (percentage of points classified as ground)</span></span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item Mean ground point density (pts/m²)</span></span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item Mean nearest-neighbor distance between ground points (meters)</span></span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a><span class="co">#' Depending on these indicators, one of the following interpolation algorithms is suggested:</span></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a><span class="co">#' \describe{</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{\code{"tin()"}}{Recommended when ground point distribution is dense and regular.}</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{\code{"knnidw(k = 6, p = 2)"}}{Used under intermediate conditions with moderate density.}</span></span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{\code{"kriging(k = 10)"}}{Recommended for sparse or clustered ground points.}</span></span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a><span class="co">#' This approach follows best practices from airborne LiDAR filtering literature, including:</span></span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a><span class="co">#' \itemize{</span></span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item Zhang et al. (2016): Cloth Simulation Filtering (CSF) – \doi{10.3390/rs8060501}</span></span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item Ma et al. (2025): Partitioned Cloth Simulation Filtering (PCSF) – \doi{10.3390/forests16071179}</span></span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item Chen et al. (2024): Adaptive DEM filtering with roughness-based interpolation – \url{https://www.sciencedirect.com/science/article/pii/S0924271624002636}</span></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a><span class="co">#' These studies suggest that interpolation performance depends strongly on the spatial characteristics</span></span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a><span class="co">#' of ground point clouds, especially in forested terrain. The chosen metrics are commonly used to</span></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a><span class="co">#' quantify LiDAR completeness and ground visibility.</span></span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso \code{\link[lidR]{rasterize_terrain}}, \code{\link[lidR]{filter_ground}}, \code{\link[lidR]{grid_density}}</span></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a><span class="co">#'   las &lt;- readLAS("data/las/forest_tile.las")</span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a><span class="co">#'   method &lt;- recommend_dem_interpolation(las, res = 1)</span></span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a><span class="co">#'   dem &lt;- rasterize_terrain(las, res = 1, algorithm = eval(parse(text = method)))</span></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom lidR readLAS filter_ground grid_density</span></span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom RANN nn2</span></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>recommend_dem_interpolation <span class="ot">&lt;-</span> <span class="cf">function</span>(las, <span class="at">res =</span> <span class="dv">1</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(las, <span class="st">"character"</span>)) las <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(las)</span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.empty</span>(las)) <span class="fu">stop</span>(<span class="st">"LAS file is empty or invalid"</span>)</span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>  ground <span class="ot">&lt;-</span> <span class="fu">filter_ground</span>(las)</span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>  cls_tab <span class="ot">&lt;-</span> <span class="fu">table</span>(las<span class="sc">@</span>data<span class="sc">$</span>Classification)</span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a>  n_total <span class="ot">&lt;-</span> <span class="fu">sum</span>(cls_tab)</span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>  n_ground <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">"2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(cls_tab)) cls_tab[<span class="st">"2"</span>] <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>  ground_pct <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(n_ground) <span class="sc">/</span> n_total</span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>  density_map <span class="ot">&lt;-</span> <span class="fu">grid_density</span>(ground, <span class="at">res =</span> res)</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>  density_vals <span class="ot">&lt;-</span> <span class="fu">values</span>(density_map)</span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>  density_vals <span class="ot">&lt;-</span> density_vals[<span class="sc">!</span><span class="fu">is.na</span>(density_vals)]</span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>  mean_density <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(density_vals) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">mean</span>(density_vals) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(ground<span class="sc">@</span>data) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a>    xy <span class="ot">&lt;-</span> ground<span class="sc">@</span>data[, <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>)]</span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>    nn_dist <span class="ot">&lt;-</span> RANN<span class="sc">::</span><span class="fu">nn2</span>(xy, <span class="at">k =</span> <span class="dv">2</span>)<span class="sc">$</span>nn.dists[, <span class="dv">2</span>]</span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>    mean_nn <span class="ot">&lt;-</span> <span class="fu">mean</span>(nn_dist)</span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>    mean_nn <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ground_pct <span class="sc">&gt;</span> <span class="dv">30</span>) score <span class="ot">&lt;-</span> score <span class="sc">+</span> <span class="dv">1</span> <span class="cf">else</span> <span class="cf">if</span> (ground_pct <span class="sc">&lt;</span> <span class="dv">10</span>) score <span class="ot">&lt;-</span> score <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (mean_density <span class="sc">&gt;</span> <span class="dv">1</span>) score <span class="ot">&lt;-</span> score <span class="sc">+</span> <span class="dv">1</span> <span class="cf">else</span> <span class="cf">if</span> (mean_density <span class="sc">&lt;</span> <span class="fl">0.3</span>) score <span class="ot">&lt;-</span> score <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (mean_nn <span class="sc">&lt;</span> <span class="fl">1.5</span>) score <span class="ot">&lt;-</span> score <span class="sc">+</span> <span class="dv">1</span> <span class="cf">else</span> <span class="cf">if</span> (mean_nn <span class="sc">&gt;</span> <span class="dv">3</span>) score <span class="ot">&lt;-</span> score <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a>  method <span class="ot">&lt;-</span> <span class="cf">if</span> (score <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tin()"</span></span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (score <span class="sc">&lt;=</span> <span class="sc">-</span><span class="dv">1</span>) {</span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kriging(k = 10)"</span></span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a>    <span class="st">"knnidw(k = 6, p = 2)"</span></span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose) {</span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"📊 Ground point ratio:     %.1f%%"</span>, ground_pct))</span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"📊 Mean ground density:   %.2f pts/m²"</span>, mean_density))</span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"📊 Mean NN distance:      %.2f m"</span>, mean_nn))</span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"✅ Recommended method:    %s"</span>, method))</span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(method)</span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a><span class="co">#' Merge LAS/LAZ tiles into a single file using `lidR::catalog_retile`</span></span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function merges LAS/LAZ tiles from a directory into a single file.</span></span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a><span class="co">#' Internally, it loads the directory as a `LAScatalog`, sets chunking to cover the entire extent,</span></span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a><span class="co">#' and writes a single merged `.laz` or `.las` file. Uses parallel processing if desired.</span></span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tile_dir Path to directory containing LAS/LAZ tiles (or a single LAS/LAZ file).</span></span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param output_file Full path to the merged output file (default: `"merged.laz"`).</span></span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param chunk_size Optional internal chunking for processing (default: `10000` m).</span></span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param workers Number of parallel workers (default: `4`).</span></span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Character string path to the created merged `.laz` file.</span></span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a><span class="co">#' merge_las_tiles("tiles/", "merged.laz", workers = 6)</span></span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a>merge_las_tiles <span class="ot">&lt;-</span> <span class="cf">function</span>(tile_dir,</span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a>                            <span class="at">output_file =</span> <span class="st">"merged.laz"</span>,</span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a>                            <span class="at">chunk_size =</span> <span class="dv">10000</span>,</span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a>                            <span class="at">workers =</span> <span class="dv">4</span>) {</span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(tile_dir) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">file.exists</span>(tile_dir)) {</span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input tile directory or file does not exist."</span>)</span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-308"><a href="#cb10-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(lidR)</span>
<span id="cb10-309"><a href="#cb10-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(future)</span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_lidr_threads</span>(workers)</span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a>  future<span class="sc">::</span><span class="fu">plan</span>(multisession, <span class="at">workers =</span> workers)</span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a>  ctg <span class="ot">&lt;-</span> <span class="fu">readLAScatalog</span>(tile_dir)</span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_chunk_size</span>(ctg) <span class="ot">&lt;-</span> chunk_size</span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_chunk_buffer</span>(ctg) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_output_files</span>(ctg) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.la[sz]$"</span>, <span class="st">""</span>, output_file)</span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Merging tiles into: "</span>, output_file)</span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">catalog_retile</span>(ctg)  <span class="co"># This writes the file</span></span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return final path with correct extension</span></span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a>  merged_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">sub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.la[sz]$"</span>, <span class="st">""</span>, output_file), <span class="st">".las"</span>)</span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(merged_path)</span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a><span class="co">#' Retile a LAS/LAZ file into regular tiles</span></span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function splits a large LAS/LAZ file into regular square tiles using `lidR::catalog_retile`.</span></span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a><span class="co">#' It supports parallel processing and optional compression.</span></span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param input_file Path to the input LAS/LAZ file.</span></span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param out_dir Directory to write the resulting tiles (default: `"tiles/"`).</span></span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param chunk_size Numeric. Tile size in meters (default: `250`).</span></span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param output_ext File extension of output tiles: either `"laz"` or `"las"` (default: `"laz"`).</span></span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param buffer Buffer size between tiles, in meters (default: `0`, i.e. no overlap).</span></span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param workers Number of parallel workers for processing (default: `4`).</span></span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A `LAScatalog` object referencing the tiled files.</span></span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a><span class="co">#' retile_las("data/input.las", out_dir = "tiles/", chunk_size = 200)</span></span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a>retile_las <span class="ot">&lt;-</span> <span class="cf">function</span>(input_file,</span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a>                       <span class="at">out_dir =</span> <span class="st">"tiles/"</span>,</span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a>                       <span class="at">chunk_size =</span> <span class="dv">250</span>,</span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a>                       <span class="at">output_ext =</span> <span class="st">"laz"</span>,</span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a>                       <span class="at">buffer =</span> <span class="dv">0</span>,</span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a>                       <span class="at">workers =</span> <span class="dv">4</span>) {</span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(input_file)) <span class="fu">stop</span>(<span class="st">"Input file not found."</span>)</span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>output_ext <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"laz"</span>, <span class="st">"las"</span>)) <span class="fu">stop</span>(<span class="st">"Invalid extension: use 'laz' or 'las'."</span>)</span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(out_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(lidR)</span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(future)</span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Enable parallel processing</span></span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_lidr_threads</span>(workers)</span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>  future<span class="sc">::</span><span class="fu">plan</span>(multisession, <span class="at">workers =</span> workers)</span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read LAS file as a catalog</span></span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a>  ctg <span class="ot">&lt;-</span> <span class="fu">readLAScatalog</span>(input_file)</span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_laz_compression</span>(ctg) <span class="ot">&lt;-</span> (output_ext <span class="sc">==</span> <span class="st">"laz"</span>)</span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_chunk_size</span>(ctg) <span class="ot">&lt;-</span> chunk_size</span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_chunk_buffer</span>(ctg) <span class="ot">&lt;-</span> buffer</span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">opt_output_files</span>(ctg) <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">paste0</span>(<span class="st">"tile_{XLEFT}_{YBOTTOM}."</span>, output_ext))</span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Tiling "</span>, input_file, <span class="st">" into "</span>, out_dir, <span class="st">" with chunk size "</span>, chunk_size, <span class="st">" m"</span>)</span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a>  tiled_ctg <span class="ot">&lt;-</span> <span class="fu">catalog_retile</span>(ctg)</span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tiled_ctg)</span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a><span class="co">#' Preprocess ALS/TLS Point Cloud into Voxel Slice Counts</span></span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function filters a normalized LAS point cloud to a maximum height (`zmax`), </span></span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a><span class="co">#' splits the points into horizontal Z-slices (via `pointsByZSlice()`), </span></span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a><span class="co">#' and computes slice-wise point counts per XY pixel using `lidR::pixel_metrics()`.</span></span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a><span class="co">#' The result is a flat data frame combining X/Y coordinates and vertical slice counts.</span></span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param normlas A normalized LAS object (e.g., output from `normalize_height()`) containing ground-aligned Z values.</span></span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res_xy Numeric. The horizontal resolution (in meters) of the XY voxel grid. Default is 2 m.</span></span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res_z Numeric. The vertical resolution (in meters) used for binning points into Z slices. Default is 2 m.</span></span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a><span class="co">#'              This is passed indirectly to `pointsByZSlice()` via `zmax`.</span></span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param zmax Numeric. The maximum height (in meters) to include for voxelization. Points above this value are excluded.</span></span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame where each row corresponds to an XY voxel column and contains:</span></span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a><span class="co">#' \describe{</span></span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{X, Y}{The center coordinates of the pixel (voxel column base).}</span></span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{ground_0_1m, pulses_1_2m, ...}{Point counts per vertical slice from `pointsByZSlice()`.}</span></span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function prepares voxel-based vertical profiles from a normalized LAS point cloud,</span></span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a><span class="co">#' which is a common preprocessing step in vegetation structure analysis, such as for:</span></span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Estimating Leaf Area Density (LAD)</span></span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Building 3D vegetation models (e.g., for ENVI-met)</span></span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Computing light extinction or aerodynamic roughness from LiDAR data</span></span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function performs the following steps:</span></span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a><span class="co">#' 1. **Z-Filtering**: Points are restricted to the height interval `[0, zmax]` to exclude</span></span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a><span class="co">#'    noise (e.g., below ground level) and irrelevant outliers (e.g., birds, clouds).</span></span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a><span class="co">#' 2. **Safety Check for Empty Point Cloud**: If filtering removes all points, the function</span></span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a><span class="co">#'    returns `NULL` to avoid errors in later processing stages.</span></span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a><span class="co">#' 3. **Dynamic Vertical Binning Limit**: The actual maximum height (`maxZ`) is computed as</span></span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a><span class="co">#'    the minimum between the highest Z-value and the user-defined `zmax`. This ensures the</span></span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a><span class="co">#'    binning range reflects both the data and physical modeling limits.</span></span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a><span class="co">#' 4. **Per-Pixel Vertical Slice Metrics**: Using `lidR::pixel_metrics()`, the function applies</span></span>
<span id="cb10-419"><a href="#cb10-419" aria-hidden="true" tabindex="-1"></a><span class="co">#'    a custom-defined metric — `pointsByZSlice(Z, maxZ)` — to each XY cell. This splits the </span></span>
<span id="cb10-420"><a href="#cb10-420" aria-hidden="true" tabindex="-1"></a><span class="co">#'    vertical column above each pixel into 1-meter height bins (Z-slices) and counts the</span></span>
<span id="cb10-421"><a href="#cb10-421" aria-hidden="true" tabindex="-1"></a><span class="co">#'    number of points in each slice. Empty bins are filled with 0 to ensure uniform output.</span></span>
<span id="cb10-422"><a href="#cb10-422" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-423"><a href="#cb10-423" aria-hidden="true" tabindex="-1"></a><span class="co">#' 5. **Raster Geometry to XY Coordinates**: The function extracts the centroid (X, Y) of each</span></span>
<span id="cb10-424"><a href="#cb10-424" aria-hidden="true" tabindex="-1"></a><span class="co">#'    pixel cell using `terra::xyFromCell()` so that slice metrics can be mapped spatially.</span></span>
<span id="cb10-425"><a href="#cb10-425" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-426"><a href="#cb10-426" aria-hidden="true" tabindex="-1"></a><span class="co">#' 6. **Output Formatting**: The final result is a flat data frame where each row represents</span></span>
<span id="cb10-427"><a href="#cb10-427" aria-hidden="true" tabindex="-1"></a><span class="co">#'    a voxel column. It includes the X/Y coordinate and point counts for each Z-slice,</span></span>
<span id="cb10-428"><a href="#cb10-428" aria-hidden="true" tabindex="-1"></a><span class="co">#'    formatted with descriptive column names like `"ground_0_1m"`, `"pulses_2_3m"`, etc.</span></span>
<span id="cb10-429"><a href="#cb10-429" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-430"><a href="#cb10-430" aria-hidden="true" tabindex="-1"></a><span class="co">#' This regularized output is designed to be compatible with downstream modeling frameworks</span></span>
<span id="cb10-431"><a href="#cb10-431" aria-hidden="true" tabindex="-1"></a><span class="co">#' (e.g., Beer–Lambert LAD computation, ENVI-met's 3DPLANT input, or machine learning models).</span></span>
<span id="cb10-432"><a href="#cb10-432" aria-hidden="true" tabindex="-1"></a><span class="co">#' It bridges the gap between unstructured 3D point clouds and gridded model inputs.</span></span>
<span id="cb10-433"><a href="#cb10-433" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-434"><a href="#cb10-434" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note The function assumes the input LAS object is already normalized to ground level </span></span>
<span id="cb10-435"><a href="#cb10-435" aria-hidden="true" tabindex="-1"></a><span class="co">#' (i.e., Z = 0 corresponds to terrain surface). Use `normalize_height()` beforehand if needed.</span></span>
<span id="cb10-436"><a href="#cb10-436" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-437"><a href="#cb10-437" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso </span></span>
<span id="cb10-438"><a href="#cb10-438" aria-hidden="true" tabindex="-1"></a><span class="co">#' [lidR::pixel_metrics()], </span></span>
<span id="cb10-439"><a href="#cb10-439" aria-hidden="true" tabindex="-1"></a><span class="co">#' [lidR::voxel_metrics()], </span></span>
<span id="cb10-440"><a href="#cb10-440" aria-hidden="true" tabindex="-1"></a><span class="co">#' [pointsByZSlice()], </span></span>
<span id="cb10-441"><a href="#cb10-441" aria-hidden="true" tabindex="-1"></a><span class="co">#' [normalize_height()], </span></span>
<span id="cb10-442"><a href="#cb10-442" aria-hidden="true" tabindex="-1"></a><span class="co">#' [terra::xyFromCell()]</span></span>
<span id="cb10-443"><a href="#cb10-443" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-444"><a href="#cb10-444" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-445"><a href="#cb10-445" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-446"><a href="#cb10-446" aria-hidden="true" tabindex="-1"></a><span class="co">#' las &lt;- lidR::readLAS("path/to/normalized.laz")</span></span>
<span id="cb10-447"><a href="#cb10-447" aria-hidden="true" tabindex="-1"></a><span class="co">#' voxel_df &lt;- preprocess_voxels(las, res_xy = 2, res_z = 2, zmax = 40)</span></span>
<span id="cb10-448"><a href="#cb10-448" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(voxel_df)</span></span>
<span id="cb10-449"><a href="#cb10-449" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-450"><a href="#cb10-450" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-451"><a href="#cb10-451" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-452"><a href="#cb10-452" aria-hidden="true" tabindex="-1"></a>preprocess_voxels <span class="ot">&lt;-</span> <span class="cf">function</span>(normlas, <span class="at">res_xy =</span> <span class="dv">2</span>, <span class="at">res_z =</span> <span class="dv">2</span>, <span class="at">zmax =</span> <span class="dv">40</span>) {</span>
<span id="cb10-453"><a href="#cb10-453" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign LAS to working variable for clarity</span></span>
<span id="cb10-454"><a href="#cb10-454" aria-hidden="true" tabindex="-1"></a>  las <span class="ot">&lt;-</span> normlas</span>
<span id="cb10-455"><a href="#cb10-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-456"><a href="#cb10-456" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Filter points to a valid height range [0, zmax]</span></span>
<span id="cb10-457"><a href="#cb10-457" aria-hidden="true" tabindex="-1"></a>  las <span class="ot">&lt;-</span> <span class="fu">filter_poi</span>(las, Z <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> Z <span class="sc">&lt;=</span> zmax)</span>
<span id="cb10-458"><a href="#cb10-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-459"><a href="#cb10-459" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Check if the LAS object is empty after filtering</span></span>
<span id="cb10-460"><a href="#cb10-460" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (lidR<span class="sc">::</span><span class="fu">is.empty</span>(las)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb10-461"><a href="#cb10-461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-462"><a href="#cb10-462" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Define maximum vertical bin based on actual max Z (floored), capped at zmax</span></span>
<span id="cb10-463"><a href="#cb10-463" aria-hidden="true" tabindex="-1"></a>  maxZ <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">floor</span>(<span class="fu">max</span>(las<span class="sc">@</span>data<span class="sc">$</span>Z)), zmax)</span>
<span id="cb10-464"><a href="#cb10-464" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-465"><a href="#cb10-465" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Define metric function for pixel-wise Z-slice counting</span></span>
<span id="cb10-466"><a href="#cb10-466" aria-hidden="true" tabindex="-1"></a>  func <span class="ot">&lt;-</span> <span class="fu">formula</span>(<span class="fu">paste0</span>(<span class="st">"~pointsByZSlice(Z, "</span>, maxZ, <span class="st">")"</span>))</span>
<span id="cb10-467"><a href="#cb10-467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-468"><a href="#cb10-468" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Compute per-pixel vertical structure using custom Z-slice function</span></span>
<span id="cb10-469"><a href="#cb10-469" aria-hidden="true" tabindex="-1"></a>  voxels <span class="ot">&lt;-</span> <span class="fu">pixel_metrics</span>(las, func, <span class="at">res =</span> res_xy)</span>
<span id="cb10-470"><a href="#cb10-470" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-471"><a href="#cb10-471" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 6: Extract the X/Y centroid coordinates of each pixel cell</span></span>
<span id="cb10-472"><a href="#cb10-472" aria-hidden="true" tabindex="-1"></a>  xy <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">xyFromCell</span>(voxels, <span class="fu">seq_len</span>(<span class="fu">ncell</span>(voxels)))</span>
<span id="cb10-473"><a href="#cb10-473" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-474"><a href="#cb10-474" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 7: Extract Z-slice point counts from each pixel cell</span></span>
<span id="cb10-475"><a href="#cb10-475" aria-hidden="true" tabindex="-1"></a>  vals <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">values</span>(voxels)</span>
<span id="cb10-476"><a href="#cb10-476" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-477"><a href="#cb10-477" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 8: Combine XY coordinates with slice values into a data frame</span></span>
<span id="cb10-478"><a href="#cb10-478" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(xy, vals)</span>
<span id="cb10-479"><a href="#cb10-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>)  <span class="co"># Rename coordinate columns</span></span>
<span id="cb10-480"><a href="#cb10-480" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-481"><a href="#cb10-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb10-482"><a href="#cb10-482" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-483"><a href="#cb10-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-484"><a href="#cb10-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-485"><a href="#cb10-485" aria-hidden="true" tabindex="-1"></a><span class="co">#' Convert Vertical Pulse Counts to LAD Using the Beer–Lambert Law</span></span>
<span id="cb10-486"><a href="#cb10-486" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-487"><a href="#cb10-487" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function applies the Beer–Lambert law to vertical LiDAR pulse count profiles</span></span>
<span id="cb10-488"><a href="#cb10-488" aria-hidden="true" tabindex="-1"></a><span class="co">#' (from voxelized ALS/TLS data) to estimate Leaf Area Density (LAD) per vertical slice.</span></span>
<span id="cb10-489"><a href="#cb10-489" aria-hidden="true" tabindex="-1"></a><span class="co">#' It normalizes the pulse density, corrects edge cases, applies the extinction formula,</span></span>
<span id="cb10-490"><a href="#cb10-490" aria-hidden="true" tabindex="-1"></a><span class="co">#' and scales or clips LAD values to stay within biologically plausible ranges.</span></span>
<span id="cb10-491"><a href="#cb10-491" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-492"><a href="#cb10-492" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param df A data frame containing columns with pulse counts per Z-slice. These columns must be named with the `"pulses_"` prefix, as produced by `pointsByZSlice()` and `preprocess_voxels()`.</span></span>
<span id="cb10-493"><a href="#cb10-493" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param grainsize Numeric. Vertical resolution of each slice (in meters). Default is 2 m.</span></span>
<span id="cb10-494"><a href="#cb10-494" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param k Numeric. Extinction coefficient (typically between 0.3 and 0.5); default is 0.3.</span></span>
<span id="cb10-495"><a href="#cb10-495" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param scale_factor Numeric. Scaling factor applied after Beer–Lambert transformation to adjust LAD magnitude (default: 1.2).</span></span>
<span id="cb10-496"><a href="#cb10-496" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_max Numeric or `NULL`. Maximum LAD value allowed (default: 2.5). Use `NULL` to disable.</span></span>
<span id="cb10-497"><a href="#cb10-497" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_min Numeric or `NULL`. Minimum LAD value allowed (default: 0.05). Use `NULL` to disable.</span></span>
<span id="cb10-498"><a href="#cb10-498" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param keep_pulses Logical. If `TRUE`, the original `"pulses_"` columns are retained in the output. Default is `FALSE`.</span></span>
<span id="cb10-499"><a href="#cb10-499" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-500"><a href="#cb10-500" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame with the same structure as input, but with new `"lad_"` columns</span></span>
<span id="cb10-501"><a href="#cb10-501" aria-hidden="true" tabindex="-1"></a><span class="co">#' for each original `"pulses_"` column, containing the estimated LAD values. </span></span>
<span id="cb10-502"><a href="#cb10-502" aria-hidden="true" tabindex="-1"></a><span class="co">#' Original pulse columns are optionally removed.</span></span>
<span id="cb10-503"><a href="#cb10-503" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-504"><a href="#cb10-504" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-505"><a href="#cb10-505" aria-hidden="true" tabindex="-1"></a><span class="co">#' The Beer–Lambert law models **light attenuation** through a medium such as foliage. In the context of LiDAR, </span></span>
<span id="cb10-506"><a href="#cb10-506" aria-hidden="true" tabindex="-1"></a><span class="co">#' this relationship is inverted to estimate **leaf area density** from the relative decrease in returned pulses:</span></span>
<span id="cb10-507"><a href="#cb10-507" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-508"><a href="#cb10-508" aria-hidden="true" tabindex="-1"></a><span class="co">#' \deqn{</span></span>
<span id="cb10-509"><a href="#cb10-509" aria-hidden="true" tabindex="-1"></a><span class="co">#' LAD = -\frac{\log(1 - p)}{k \cdot \Delta z}</span></span>
<span id="cb10-510"><a href="#cb10-510" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-511"><a href="#cb10-511" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-512"><a href="#cb10-512" aria-hidden="true" tabindex="-1"></a><span class="co">#' where:</span></span>
<span id="cb10-513"><a href="#cb10-513" aria-hidden="true" tabindex="-1"></a><span class="co">#' - \( p \) is the normalized proportion of pulses in a given voxel column and slice</span></span>
<span id="cb10-514"><a href="#cb10-514" aria-hidden="true" tabindex="-1"></a><span class="co">#' - \( k \) is the extinction coefficient (typically 0.3–0.5)</span></span>
<span id="cb10-515"><a href="#cb10-515" aria-hidden="true" tabindex="-1"></a><span class="co">#' - \( \Delta z \) is the vertical resolution of the slice (grainsize)</span></span>
<span id="cb10-516"><a href="#cb10-516" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-517"><a href="#cb10-517" aria-hidden="true" tabindex="-1"></a><span class="co">#' To avoid mathematical issues:</span></span>
<span id="cb10-518"><a href="#cb10-518" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Values of \( p \geq 1 \) are clipped to 0.9999</span></span>
<span id="cb10-519"><a href="#cb10-519" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Values of \( p \leq 0 \) are clipped to 1e-5</span></span>
<span id="cb10-520"><a href="#cb10-520" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-521"><a href="#cb10-521" aria-hidden="true" tabindex="-1"></a><span class="co">#' A **scaling factor** can be applied to tune the LAD magnitude (empirical correction).</span></span>
<span id="cb10-522"><a href="#cb10-522" aria-hidden="true" tabindex="-1"></a><span class="co">#' LAD values are optionally clipped to a maximum and minimum for ecological realism or </span></span>
<span id="cb10-523"><a href="#cb10-523" aria-hidden="true" tabindex="-1"></a><span class="co">#' to avoid over-saturation artifacts in further modeling (e.g., radiative transfer, ENVI-met input).</span></span>
<span id="cb10-524"><a href="#cb10-524" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-525"><a href="#cb10-525" aria-hidden="true" tabindex="-1"></a><span class="co">#' This approach assumes:</span></span>
<span id="cb10-526"><a href="#cb10-526" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Pulse counts per slice are proportional to occlusion probability</span></span>
<span id="cb10-527"><a href="#cb10-527" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Normalization by column maximum represents local beam extinction well enough</span></span>
<span id="cb10-528"><a href="#cb10-528" aria-hidden="true" tabindex="-1"></a><span class="co">#' - The LiDAR pulse distribution is representative of foliage density (most valid in leaf-on conditions)</span></span>
<span id="cb10-529"><a href="#cb10-529" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-530"><a href="#cb10-530" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note</span></span>
<span id="cb10-531"><a href="#cb10-531" aria-hidden="true" tabindex="-1"></a><span class="co">#' - For ALS data, this method provides an **approximate LAD profile** suitable for modeling but</span></span>
<span id="cb10-532"><a href="#cb10-532" aria-hidden="true" tabindex="-1"></a><span class="co">#'   not physically exact. For more accurate LAD estimation, full waveform or TLS data is preferred.</span></span>
<span id="cb10-533"><a href="#cb10-533" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Normalization by max pulse count assumes that the densest slice corresponds to near-complete attenuation.</span></span>
<span id="cb10-534"><a href="#cb10-534" aria-hidden="true" tabindex="-1"></a><span class="co">#'   This introduces uncertainty if canopy gaps dominate the scene.</span></span>
<span id="cb10-535"><a href="#cb10-535" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-536"><a href="#cb10-536" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso</span></span>
<span id="cb10-537"><a href="#cb10-537" aria-hidden="true" tabindex="-1"></a><span class="co">#' [preprocess_voxels()], [pointsByZSlice()], [lidR::voxel_metrics()], [terra::rast()]</span></span>
<span id="cb10-538"><a href="#cb10-538" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-539"><a href="#cb10-539" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-540"><a href="#cb10-540" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-541"><a href="#cb10-541" aria-hidden="true" tabindex="-1"></a><span class="co">#' df_voxels &lt;- preprocess_voxels(las)</span></span>
<span id="cb10-542"><a href="#cb10-542" aria-hidden="true" tabindex="-1"></a><span class="co">#' df_lad &lt;- convert_to_LAD_beer(df_voxels, grainsize = 2, k = 0.3)</span></span>
<span id="cb10-543"><a href="#cb10-543" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(df_lad)</span></span>
<span id="cb10-544"><a href="#cb10-544" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-545"><a href="#cb10-545" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-546"><a href="#cb10-546" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-547"><a href="#cb10-547" aria-hidden="true" tabindex="-1"></a>convert_to_LAD_beer <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">grainsize =</span> <span class="dv">2</span>, <span class="at">k =</span> <span class="fl">0.3</span>, <span class="at">scale_factor =</span> <span class="fl">1.2</span>,</span>
<span id="cb10-548"><a href="#cb10-548" aria-hidden="true" tabindex="-1"></a>                                <span class="at">lad_max =</span> <span class="fl">2.5</span>, <span class="at">lad_min =</span> <span class="fl">0.000</span>, <span class="at">keep_pulses =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb10-549"><a href="#cb10-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-550"><a href="#cb10-550" aria-hidden="true" tabindex="-1"></a>  df_lad <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df)</span>
<span id="cb10-551"><a href="#cb10-551" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find all columns containing vertical pulse count data</span></span>
<span id="cb10-552"><a href="#cb10-552" aria-hidden="true" tabindex="-1"></a>  pulse_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^pulses_"</span>, <span class="fu">names</span>(df_lad), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-553"><a href="#cb10-553" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-554"><a href="#cb10-554" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Iterate over each pulse column (i.e., per Z-slice)</span></span>
<span id="cb10-555"><a href="#cb10-555" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> pulse_cols) {</span>
<span id="cb10-556"><a href="#cb10-556" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct name for LAD output column</span></span>
<span id="cb10-557"><a href="#cb10-557" aria-hidden="true" tabindex="-1"></a>    lad_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"lad_"</span>, col)</span>
<span id="cb10-558"><a href="#cb10-558" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-559"><a href="#cb10-559" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize pulse density per column (relative to max)</span></span>
<span id="cb10-560"><a href="#cb10-560" aria-hidden="true" tabindex="-1"></a>    p_rel <span class="ot">&lt;-</span> df_lad[[col]] <span class="sc">/</span> <span class="fu">max</span>(df_lad[[col]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-561"><a href="#cb10-561" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-562"><a href="#cb10-562" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Avoid values of 0 or 1 that would break log(1 - p)</span></span>
<span id="cb10-563"><a href="#cb10-563" aria-hidden="true" tabindex="-1"></a>    <span class="co"># p_rel[p_rel &gt;= 1] &lt;- 0.9999</span></span>
<span id="cb10-564"><a href="#cb10-564" aria-hidden="true" tabindex="-1"></a>    <span class="co"># p_rel[p_rel &lt;= 0] &lt;- 1e-5</span></span>
<span id="cb10-565"><a href="#cb10-565" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-566"><a href="#cb10-566" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply Beer–Lambert transformation to estimate LAD</span></span>
<span id="cb10-567"><a href="#cb10-567" aria-hidden="true" tabindex="-1"></a>    <span class="co">#lad_vals &lt;- -log1p(1 - p_rel) / (k * grainsize)</span></span>
<span id="cb10-568"><a href="#cb10-568" aria-hidden="true" tabindex="-1"></a>    lad_vals <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log1p</span>(<span class="sc">-</span>p_rel) <span class="sc">/</span> (k <span class="sc">*</span> grainsize)</span>
<span id="cb10-569"><a href="#cb10-569" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-570"><a href="#cb10-570" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply empirical scale factor to adjust LAD magnitude</span></span>
<span id="cb10-571"><a href="#cb10-571" aria-hidden="true" tabindex="-1"></a>    lad_vals <span class="ot">&lt;-</span> lad_vals <span class="sc">*</span> scale_factor</span>
<span id="cb10-572"><a href="#cb10-572" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-573"><a href="#cb10-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enforce maximum and minimum LAD values (if set)</span></span>
<span id="cb10-574"><a href="#cb10-574" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lad_max)) {</span>
<span id="cb10-575"><a href="#cb10-575" aria-hidden="true" tabindex="-1"></a>      lad_vals <span class="ot">&lt;-</span> <span class="fu">pmin</span>(lad_vals, lad_max)</span>
<span id="cb10-576"><a href="#cb10-576" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-577"><a href="#cb10-577" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lad_min)) {</span>
<span id="cb10-578"><a href="#cb10-578" aria-hidden="true" tabindex="-1"></a>      lad_vals <span class="ot">&lt;-</span> <span class="fu">pmax</span>(lad_vals, lad_min)</span>
<span id="cb10-579"><a href="#cb10-579" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-580"><a href="#cb10-580" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-581"><a href="#cb10-581" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store LAD values in new column</span></span>
<span id="cb10-582"><a href="#cb10-582" aria-hidden="true" tabindex="-1"></a>    df_lad[[lad_col]] <span class="ot">&lt;-</span> lad_vals</span>
<span id="cb10-583"><a href="#cb10-583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-584"><a href="#cb10-584" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally remove original pulse column</span></span>
<span id="cb10-585"><a href="#cb10-585" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>keep_pulses) {</span>
<span id="cb10-586"><a href="#cb10-586" aria-hidden="true" tabindex="-1"></a>      df_lad[[col]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb10-587"><a href="#cb10-587" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-588"><a href="#cb10-588" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-589"><a href="#cb10-589" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-590"><a href="#cb10-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_lad)</span>
<span id="cb10-591"><a href="#cb10-591" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-592"><a href="#cb10-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-593"><a href="#cb10-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-594"><a href="#cb10-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-595"><a href="#cb10-595" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute Canopy Traits from Long-Format LAD Profiles</span></span>
<span id="cb10-596"><a href="#cb10-596" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-597"><a href="#cb10-597" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function calculates key vegetation structure metrics from long-format </span></span>
<span id="cb10-598"><a href="#cb10-598" aria-hidden="true" tabindex="-1"></a><span class="co">#' Leaf Area Density (LAD) profiles, grouped by `ENVIMET_ID`. These traits </span></span>
<span id="cb10-599"><a href="#cb10-599" aria-hidden="true" tabindex="-1"></a><span class="co">#' include Leaf Area Index (LAI), maximum LAD, crown height, total height, </span></span>
<span id="cb10-600"><a href="#cb10-600" aria-hidden="true" tabindex="-1"></a><span class="co">#' leaf thickness, and aerodynamic roughness length, all of which are relevant </span></span>
<span id="cb10-601"><a href="#cb10-601" aria-hidden="true" tabindex="-1"></a><span class="co">#' for canopy modeling (e.g., in ENVI-met).</span></span>
<span id="cb10-602"><a href="#cb10-602" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-603"><a href="#cb10-603" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_df A long-format data frame containing LAD values per voxel slice.</span></span>
<span id="cb10-604"><a href="#cb10-604" aria-hidden="true" tabindex="-1"></a><span class="co">#' Must include at least `ENVIMET_ID`, `lad`, `z`, and optionally `Height_CHM`, `LeafThickness`, and `cluster`.</span></span>
<span id="cb10-605"><a href="#cb10-605" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res_z Vertical voxel resolution (in meters). Default is 2 m.</span></span>
<span id="cb10-606"><a href="#cb10-606" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param LAD_cutoff Minimum LAD threshold for crown detection and trait computation (default: 0.05).</span></span>
<span id="cb10-607"><a href="#cb10-607" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param leaf_thickness_df Optional data frame mapping `cluster` to `LeafThickness` values.</span></span>
<span id="cb10-608"><a href="#cb10-608" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param roughness_fun A function to derive aerodynamic roughness length from total height.</span></span>
<span id="cb10-609"><a href="#cb10-609" aria-hidden="true" tabindex="-1"></a><span class="co">#' Defaults to `height * 0.1`, but can be replaced with empirical models.</span></span>
<span id="cb10-610"><a href="#cb10-610" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param plantclass_prefix Character string used to label the plant class, typically `"Tree"` or `"Plant"`.</span></span>
<span id="cb10-611"><a href="#cb10-611" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-612"><a href="#cb10-612" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame with one row per `ENVIMET_ID` and the following columns:</span></span>
<span id="cb10-613"><a href="#cb10-613" aria-hidden="true" tabindex="-1"></a><span class="co">#' \describe{</span></span>
<span id="cb10-614"><a href="#cb10-614" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{ENVIMET_ID}{Unique identifier for the plant object (voxel column or point).}</span></span>
<span id="cb10-615"><a href="#cb10-615" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{LAI}{Leaf Area Index (sum of LAD across vertical profile, clipped at 95th percentile).}</span></span>
<span id="cb10-616"><a href="#cb10-616" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{MaxLAD}{Maximum LAD value (95th percentile capped at 3).}</span></span>
<span id="cb10-617"><a href="#cb10-617" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{CrownHeight}{Height (in res_z units) of topmost voxel with LAD above cutoff.}</span></span>
<span id="cb10-618"><a href="#cb10-618" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{Height}{Estimated total plant height, based on CHM or max Z.}</span></span>
<span id="cb10-619"><a href="#cb10-619" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{LeafThickness}{Estimated or provided leaf thickness (from lookup table or column).}</span></span>
<span id="cb10-620"><a href="#cb10-620" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{LADcutoff}{The LAD threshold used for crown height filtering.}</span></span>
<span id="cb10-621"><a href="#cb10-621" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{RoughnessLength}{Estimated aerodynamic roughness length (via `roughness_fun`).}</span></span>
<span id="cb10-622"><a href="#cb10-622" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{plantclass}{String ID used for matching plant profile in simulations.}</span></span>
<span id="cb10-623"><a href="#cb10-623" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-624"><a href="#cb10-624" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-625"><a href="#cb10-625" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-626"><a href="#cb10-626" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function summarizes vertical LAD profiles (from ALS or TLS data) into trait values </span></span>
<span id="cb10-627"><a href="#cb10-627" aria-hidden="true" tabindex="-1"></a><span class="co">#' that are essential for microclimate or ecological modeling. The key components:</span></span>
<span id="cb10-628"><a href="#cb10-628" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-629"><a href="#cb10-629" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **LAI**: Computed as the sum of LAD values per profile, excluding extreme values above </span></span>
<span id="cb10-630"><a href="#cb10-630" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the 95th percentile to avoid waveform or outlier artifacts.</span></span>
<span id="cb10-631"><a href="#cb10-631" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-632"><a href="#cb10-632" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **MaxLAD**: The 95th percentile LAD value, capped at 3 to avoid unphysical spikes.</span></span>
<span id="cb10-633"><a href="#cb10-633" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-634"><a href="#cb10-634" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **CrownHeight**: The highest voxel (Z/res_z) with LAD above the cutoff threshold, interpreted </span></span>
<span id="cb10-635"><a href="#cb10-635" aria-hidden="true" tabindex="-1"></a><span class="co">#'   as the vertical extent of the crown (not the total plant height).</span></span>
<span id="cb10-636"><a href="#cb10-636" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-637"><a href="#cb10-637" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Height**: Either taken from an external `Height_CHM` column (if provided), or estimated </span></span>
<span id="cb10-638"><a href="#cb10-638" aria-hidden="true" tabindex="-1"></a><span class="co">#'   as the maximum Z value in the profile × `res_z`.</span></span>
<span id="cb10-639"><a href="#cb10-639" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-640"><a href="#cb10-640" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **LeafThickness**: Optionally joined from a lookup table (`leaf_thickness_df`) using `cluster`.</span></span>
<span id="cb10-641"><a href="#cb10-641" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-642"><a href="#cb10-642" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **RoughnessLength**: Estimated from height using a customizable function (default: 10% of height).</span></span>
<span id="cb10-643"><a href="#cb10-643" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-644"><a href="#cb10-644" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function ensures compatibility with ENVI-met’s 3DPLANT system, where LAI, MaxLAD, and </span></span>
<span id="cb10-645"><a href="#cb10-645" aria-hidden="true" tabindex="-1"></a><span class="co">#' CrownHeight directly map to physical vegetation parameters in `.pld` files.</span></span>
<span id="cb10-646"><a href="#cb10-646" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-647"><a href="#cb10-647" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note</span></span>
<span id="cb10-648"><a href="#cb10-648" aria-hidden="true" tabindex="-1"></a><span class="co">#' - CrownHeight is returned in voxel units (Z index × res_z); it is not a biologically precise</span></span>
<span id="cb10-649"><a href="#cb10-649" aria-hidden="true" tabindex="-1"></a><span class="co">#'   crown base height but an upper limit used for model placement.</span></span>
<span id="cb10-650"><a href="#cb10-650" aria-hidden="true" tabindex="-1"></a><span class="co">#' - The input `lad_df` must be long-format, with rows representing individual vertical slices per plant.</span></span>
<span id="cb10-651"><a href="#cb10-651" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-652"><a href="#cb10-652" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso</span></span>
<span id="cb10-653"><a href="#cb10-653" aria-hidden="true" tabindex="-1"></a><span class="co">#' [convert_to_LAD_beer()], [export_lad_to_envimet3d()], [normalize_height()], [rasterize_canopy()]</span></span>
<span id="cb10-654"><a href="#cb10-654" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-655"><a href="#cb10-655" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-656"><a href="#cb10-656" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-657"><a href="#cb10-657" aria-hidden="true" tabindex="-1"></a><span class="co">#' traits_df &lt;- compute_traits_from_lad(lad_long_df, res_z = 2)</span></span>
<span id="cb10-658"><a href="#cb10-658" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(traits_df)</span></span>
<span id="cb10-659"><a href="#cb10-659" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-660"><a href="#cb10-660" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-661"><a href="#cb10-661" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-662"><a href="#cb10-662" aria-hidden="true" tabindex="-1"></a>compute_traits_from_lad <span class="ot">&lt;-</span> <span class="cf">function</span>(lad_df, <span class="at">res_z =</span> <span class="dv">2</span>, <span class="at">LAD_cutoff =</span> <span class="fl">0.05</span>,</span>
<span id="cb10-663"><a href="#cb10-663" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">leaf_thickness_df =</span> <span class="cn">NULL</span>,</span>
<span id="cb10-664"><a href="#cb10-664" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">roughness_fun =</span> <span class="cf">function</span>(height) height <span class="sc">*</span> <span class="fl">0.1</span>,</span>
<span id="cb10-665"><a href="#cb10-665" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">plantclass_prefix =</span> <span class="st">"Tree"</span>) {</span>
<span id="cb10-666"><a href="#cb10-666" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-667"><a href="#cb10-667" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional: merge leaf thickness values if available</span></span>
<span id="cb10-668"><a href="#cb10-668" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(leaf_thickness_df)) {</span>
<span id="cb10-669"><a href="#cb10-669" aria-hidden="true" tabindex="-1"></a>    lad_df <span class="ot">&lt;-</span> lad_df <span class="sc">%&gt;%</span></span>
<span id="cb10-670"><a href="#cb10-670" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(leaf_thickness_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(cluster, LeafThickness), <span class="at">by =</span> <span class="st">"cluster"</span>)</span>
<span id="cb10-671"><a href="#cb10-671" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-672"><a href="#cb10-672" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-673"><a href="#cb10-673" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split by ENVIMET_ID (each plant or tree column)</span></span>
<span id="cb10-674"><a href="#cb10-674" aria-hidden="true" tabindex="-1"></a>  groups <span class="ot">&lt;-</span> <span class="fu">split</span>(lad_df, lad_df<span class="sc">$</span>ENVIMET_ID)</span>
<span id="cb10-675"><a href="#cb10-675" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-676"><a href="#cb10-676" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Trait calculation for each plant object</span></span>
<span id="cb10-677"><a href="#cb10-677" aria-hidden="true" tabindex="-1"></a>  result_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(groups, <span class="cf">function</span>(group_df) {</span>
<span id="cb10-678"><a href="#cb10-678" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-679"><a href="#cb10-679" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LAD filtering: keep values under 95th percentile and above cutoff</span></span>
<span id="cb10-680"><a href="#cb10-680" aria-hidden="true" tabindex="-1"></a>    lad_95 <span class="ot">&lt;-</span> <span class="fu">quantile</span>(group_df<span class="sc">$</span>lad, <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-681"><a href="#cb10-681" aria-hidden="true" tabindex="-1"></a>    lad_filtered <span class="ot">&lt;-</span> group_df<span class="sc">$</span>lad[group_df<span class="sc">$</span>lad <span class="sc">&lt;=</span> lad_95 <span class="sc">&amp;</span> group_df<span class="sc">$</span>lad <span class="sc">&gt;</span> LAD_cutoff]</span>
<span id="cb10-682"><a href="#cb10-682" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-683"><a href="#cb10-683" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LAI: sum of LAD (unit is m²/m² if LAD is in m²/m³ × height slice)</span></span>
<span id="cb10-684"><a href="#cb10-684" aria-hidden="true" tabindex="-1"></a>    lai <span class="ot">&lt;-</span> <span class="fu">sum</span>(lad_filtered, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-685"><a href="#cb10-685" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-686"><a href="#cb10-686" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MaxLAD: 95th percentile capped at a max of 3</span></span>
<span id="cb10-687"><a href="#cb10-687" aria-hidden="true" tabindex="-1"></a>    max_lad <span class="ot">&lt;-</span> <span class="fu">min</span>(lad_95, <span class="dv">3</span>)</span>
<span id="cb10-688"><a href="#cb10-688" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-689"><a href="#cb10-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crown height: highest voxel slice above LAD threshold</span></span>
<span id="cb10-690"><a href="#cb10-690" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(group_df<span class="sc">$</span>lad <span class="sc">&gt;</span> LAD_cutoff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb10-691"><a href="#cb10-691" aria-hidden="true" tabindex="-1"></a>      crown_z <span class="ot">&lt;-</span> <span class="fu">max</span>(group_df<span class="sc">$</span>z[group_df<span class="sc">$</span>lad <span class="sc">&gt;</span> LAD_cutoff]<span class="sc">/</span>res_z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-692"><a href="#cb10-692" aria-hidden="true" tabindex="-1"></a>      crown_height <span class="ot">&lt;-</span> crown_z</span>
<span id="cb10-693"><a href="#cb10-693" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-694"><a href="#cb10-694" aria-hidden="true" tabindex="-1"></a>      crown_height <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb10-695"><a href="#cb10-695" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-696"><a href="#cb10-696" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-697"><a href="#cb10-697" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total plant height: prefer CHM column, fall back to max Z</span></span>
<span id="cb10-698"><a href="#cb10-698" aria-hidden="true" tabindex="-1"></a>    height_value <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">"Height_CHM"</span> <span class="sc">%in%</span> <span class="fu">names</span>(group_df) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(group_df<span class="sc">$</span>Height_CHM))) {</span>
<span id="cb10-699"><a href="#cb10-699" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>(group_df<span class="sc">$</span>Height_CHM)[<span class="dv">1</span>]</span>
<span id="cb10-700"><a href="#cb10-700" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-701"><a href="#cb10-701" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(group_df<span class="sc">$</span>z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> res_z</span>
<span id="cb10-702"><a href="#cb10-702" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-703"><a href="#cb10-703" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-704"><a href="#cb10-704" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Leaf thickness: taken from joined lookup or left NA</span></span>
<span id="cb10-705"><a href="#cb10-705" aria-hidden="true" tabindex="-1"></a>    lt <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="st">"LeafThickness"</span> <span class="sc">%in%</span> <span class="fu">names</span>(group_df)) {</span>
<span id="cb10-706"><a href="#cb10-706" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unique</span>(group_df<span class="sc">$</span>LeafThickness)[<span class="dv">1</span>]</span>
<span id="cb10-707"><a href="#cb10-707" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-708"><a href="#cb10-708" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NA</span></span>
<span id="cb10-709"><a href="#cb10-709" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-710"><a href="#cb10-710" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-711"><a href="#cb10-711" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return one row of traits</span></span>
<span id="cb10-712"><a href="#cb10-712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb10-713"><a href="#cb10-713" aria-hidden="true" tabindex="-1"></a>      <span class="at">ENVIMET_ID =</span> <span class="fu">unique</span>(group_df<span class="sc">$</span>ENVIMET_ID),</span>
<span id="cb10-714"><a href="#cb10-714" aria-hidden="true" tabindex="-1"></a>      <span class="at">LAI =</span> lai,</span>
<span id="cb10-715"><a href="#cb10-715" aria-hidden="true" tabindex="-1"></a>      <span class="at">MaxLAD =</span> max_lad,</span>
<span id="cb10-716"><a href="#cb10-716" aria-hidden="true" tabindex="-1"></a>      <span class="at">CrownHeight =</span> crown_height,</span>
<span id="cb10-717"><a href="#cb10-717" aria-hidden="true" tabindex="-1"></a>      <span class="at">Height =</span> height_value,</span>
<span id="cb10-718"><a href="#cb10-718" aria-hidden="true" tabindex="-1"></a>      <span class="at">LeafThickness =</span> lt,</span>
<span id="cb10-719"><a href="#cb10-719" aria-hidden="true" tabindex="-1"></a>      <span class="at">LADcutoff =</span> LAD_cutoff,</span>
<span id="cb10-720"><a href="#cb10-720" aria-hidden="true" tabindex="-1"></a>      <span class="at">RoughnessLength =</span> <span class="fu">roughness_fun</span>(height_value),</span>
<span id="cb10-721"><a href="#cb10-721" aria-hidden="true" tabindex="-1"></a>      <span class="at">plantclass =</span> <span class="fu">paste0</span>(plantclass_prefix, <span class="st">"_"</span>, <span class="fu">unique</span>(group_df<span class="sc">$</span>ENVIMET_ID))</span>
<span id="cb10-722"><a href="#cb10-722" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-723"><a href="#cb10-723" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb10-724"><a href="#cb10-724" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-725"><a href="#cb10-725" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all into one data frame</span></span>
<span id="cb10-726"><a href="#cb10-726" aria-hidden="true" tabindex="-1"></a>  traits_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, result_list)</span>
<span id="cb10-727"><a href="#cb10-727" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-728"><a href="#cb10-728" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows with missing LAI (empty plant objects)</span></span>
<span id="cb10-729"><a href="#cb10-729" aria-hidden="true" tabindex="-1"></a>  traits_df <span class="ot">&lt;-</span> traits_df[<span class="sc">!</span><span class="fu">is.na</span>(traits_df<span class="sc">$</span>LAI), ]</span>
<span id="cb10-730"><a href="#cb10-730" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-731"><a href="#cb10-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(traits_df)</span>
<span id="cb10-732"><a href="#cb10-732" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-733"><a href="#cb10-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-734"><a href="#cb10-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-735"><a href="#cb10-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-736"><a href="#cb10-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-737"><a href="#cb10-737" aria-hidden="true" tabindex="-1"></a><span class="co">#' Export Clustered LAD Profiles to ENVI-met PLANT3D (.pld) XML Format</span></span>
<span id="cb10-738"><a href="#cb10-738" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-739"><a href="#cb10-739" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function exports vertical LAD profiles (e.g., from TLS or ALS clustering) to</span></span>
<span id="cb10-740"><a href="#cb10-740" aria-hidden="true" tabindex="-1"></a><span class="co">#' ENVI-met-compatible 3DPLANT XML (.pld) files. Each profile is mapped to a species definition,</span></span>
<span id="cb10-741"><a href="#cb10-741" aria-hidden="true" tabindex="-1"></a><span class="co">#' associated with a seasonal LAI and blossom cycle, and written in sparse matrix format.</span></span>
<span id="cb10-742"><a href="#cb10-742" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-743"><a href="#cb10-743" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_df A long-format data frame with LAD values per voxel slice and per plant.</span></span>
<span id="cb10-744"><a href="#cb10-744" aria-hidden="true" tabindex="-1"></a><span class="co">#' Must contain columns `ENVIMET_ID`, `z`, and `lad`. Optionally includes `species_class`.</span></span>
<span id="cb10-745"><a href="#cb10-745" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param file_out Output file path for the `.pld` XML file. Default is `"tls_envimet_tree.pld"`.</span></span>
<span id="cb10-746"><a href="#cb10-746" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res_z Vertical resolution of LAD slices (in meters). Default is 1 m.</span></span>
<span id="cb10-747"><a href="#cb10-747" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param trait_df Optional data frame of additional plant traits (unused here but compatible for future use).</span></span>
<span id="cb10-748"><a href="#cb10-748" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-749"><a href="#cb10-749" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Writes an XML file to disk in ENVI-met PLANT3D format and prints confirmation to console.</span></span>
<span id="cb10-750"><a href="#cb10-750" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-751"><a href="#cb10-751" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-752"><a href="#cb10-752" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function is used to convert voxelized and clustered LAD profiles derived from TLS/ALS into</span></span>
<span id="cb10-753"><a href="#cb10-753" aria-hidden="true" tabindex="-1"></a><span class="co">#' XML `.pld` files for use in ENVI-met's 3DPLANT vegetation modeling system.</span></span>
<span id="cb10-754"><a href="#cb10-754" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-755"><a href="#cb10-755" aria-hidden="true" tabindex="-1"></a><span class="co">#' For each unique `ENVIMET_ID` (typically corresponding to a tree column), a separate `&lt;PLANT3D&gt;` block</span></span>
<span id="cb10-756"><a href="#cb10-756" aria-hidden="true" tabindex="-1"></a><span class="co">#' is generated. Each plant object is assigned:</span></span>
<span id="cb10-757"><a href="#cb10-757" aria-hidden="true" tabindex="-1"></a><span class="co">#' - A default or class-based species name (e.g., `"Fagus sylvatica"`)</span></span>
<span id="cb10-758"><a href="#cb10-758" aria-hidden="true" tabindex="-1"></a><span class="co">#' - A height based on the number of vertical LAD layers</span></span>
<span id="cb10-759"><a href="#cb10-759" aria-hidden="true" tabindex="-1"></a><span class="co">#' - LAD values in sparse 3D format</span></span>
<span id="cb10-760"><a href="#cb10-760" aria-hidden="true" tabindex="-1"></a><span class="co">#' - A monthly season and blossom profile (12 months)</span></span>
<span id="cb10-761"><a href="#cb10-761" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-762"><a href="#cb10-762" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function uses a predefined lookup table (`custom_profiles`) for assigning seasonal LAI and blossom </span></span>
<span id="cb10-763"><a href="#cb10-763" aria-hidden="true" tabindex="-1"></a><span class="co">#' curves to known species. Unmapped species default to generic "broadleaf" or "conifer" profiles.</span></span>
<span id="cb10-764"><a href="#cb10-764" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-765"><a href="#cb10-765" aria-hidden="true" tabindex="-1"></a><span class="co">#' Species-specific traits such as `Albedo`, `Transmittance`, `RootDiameter`, and `LeafType` are hard-coded</span></span>
<span id="cb10-766"><a href="#cb10-766" aria-hidden="true" tabindex="-1"></a><span class="co">#' per class ID but can be extended as needed.</span></span>
<span id="cb10-767"><a href="#cb10-767" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-768"><a href="#cb10-768" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note</span></span>
<span id="cb10-769"><a href="#cb10-769" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `species_class` must be numeric and match predefined mappings. Unknown classes fall back to a default.</span></span>
<span id="cb10-770"><a href="#cb10-770" aria-hidden="true" tabindex="-1"></a><span class="co">#' - LAD values are averaged across horizontal slices (X/Y = 1) and rounded to 5 decimals.</span></span>
<span id="cb10-771"><a href="#cb10-771" aria-hidden="true" tabindex="-1"></a><span class="co">#' - The LAD format is `"sparematrix-3D"` with only z-direction layers, suitable for columnar tree shapes.</span></span>
<span id="cb10-772"><a href="#cb10-772" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-773"><a href="#cb10-773" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso</span></span>
<span id="cb10-774"><a href="#cb10-774" aria-hidden="true" tabindex="-1"></a><span class="co">#' [compute_traits_from_lad()], [convert_to_LAD_beer()], [ENVI-met documentation on PLANT3D profiles]</span></span>
<span id="cb10-775"><a href="#cb10-775" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-776"><a href="#cb10-776" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-777"><a href="#cb10-777" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-778"><a href="#cb10-778" aria-hidden="true" tabindex="-1"></a><span class="co">#' export_lad_to_envimet_p3d(lad_df = my_lad_data, file_out = "trees.pld", res_z = 1)</span></span>
<span id="cb10-779"><a href="#cb10-779" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-780"><a href="#cb10-780" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-781"><a href="#cb10-781" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-782"><a href="#cb10-782" aria-hidden="true" tabindex="-1"></a>export_lad_to_envimet_p3d <span class="ot">&lt;-</span> <span class="cf">function</span>(lad_df, <span class="at">file_out =</span> <span class="st">"tls_envimet_tree.pld"</span>, <span class="at">res_z =</span> <span class="dv">1</span>, <span class="at">trait_df =</span> <span class="cn">NULL</span>) {</span>
<span id="cb10-783"><a href="#cb10-783" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Define seasonal LAI/blossom profiles per species ---</span></span>
<span id="cb10-784"><a href="#cb10-784" aria-hidden="true" tabindex="-1"></a>  season_profiles <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-785"><a href="#cb10-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">broadleaf =</span> <span class="fu">list</span>(</span>
<span id="cb10-786"><a href="#cb10-786" aria-hidden="true" tabindex="-1"></a>      <span class="at">Season =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.7</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.8</span>, <span class="fl">0.6</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>),</span>
<span id="cb10-787"><a href="#cb10-787" aria-hidden="true" tabindex="-1"></a>      <span class="at">Blossom =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb10-788"><a href="#cb10-788" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb10-789"><a href="#cb10-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">conifer =</span> <span class="fu">list</span>(</span>
<span id="cb10-790"><a href="#cb10-790" aria-hidden="true" tabindex="-1"></a>      <span class="at">Season =</span> <span class="fu">rep</span>(<span class="fl">0.8</span>, <span class="dv">12</span>),</span>
<span id="cb10-791"><a href="#cb10-791" aria-hidden="true" tabindex="-1"></a>      <span class="at">Blossom =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">12</span>)</span>
<span id="cb10-792"><a href="#cb10-792" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-793"><a href="#cb10-793" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-794"><a href="#cb10-794" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-795"><a href="#cb10-795" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Assign species-specific profiles if known ---</span></span>
<span id="cb10-796"><a href="#cb10-796" aria-hidden="true" tabindex="-1"></a>  custom_profiles <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-797"><a href="#cb10-797" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fagus sylvatica"</span> <span class="ot">=</span> season_profiles<span class="sc">$</span>broadleaf,</span>
<span id="cb10-798"><a href="#cb10-798" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alnus glutinosa"</span> <span class="ot">=</span> season_profiles<span class="sc">$</span>broadleaf,</span>
<span id="cb10-799"><a href="#cb10-799" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fraxinus excelsior"</span> <span class="ot">=</span> season_profiles<span class="sc">$</span>broadleaf,</span>
<span id="cb10-800"><a href="#cb10-800" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pseudotsuga menziesii"</span> <span class="ot">=</span> season_profiles<span class="sc">$</span>conifer,</span>
<span id="cb10-801"><a href="#cb10-801" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Larix decidua"</span> <span class="ot">=</span> season_profiles<span class="sc">$</span>broadleaf,</span>
<span id="cb10-802"><a href="#cb10-802" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Quercus robur"</span> <span class="ot">=</span> season_profiles<span class="sc">$</span>broadleaf,</span>
<span id="cb10-803"><a href="#cb10-803" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Picea abies"</span> <span class="ot">=</span> <span class="fu">list</span>(<span class="at">Season =</span> <span class="fu">rep</span>(<span class="fl">0.75</span>, <span class="dv">12</span>), <span class="at">Blossom =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">12</span>))</span>
<span id="cb10-804"><a href="#cb10-804" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-805"><a href="#cb10-805" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-806"><a href="#cb10-806" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Clean input and encode Z-layer index ---</span></span>
<span id="cb10-807"><a href="#cb10-807" aria-hidden="true" tabindex="-1"></a>  lad_df <span class="ot">&lt;-</span> lad_df[<span class="sc">!</span><span class="fu">is.na</span>(lad_df<span class="sc">$</span>lad), ]</span>
<span id="cb10-808"><a href="#cb10-808" aria-hidden="true" tabindex="-1"></a>  z_map <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">seq_along</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(lad_df<span class="sc">$</span>z))), <span class="fu">sort</span>(<span class="fu">unique</span>(lad_df<span class="sc">$</span>z)))</span>
<span id="cb10-809"><a href="#cb10-809" aria-hidden="true" tabindex="-1"></a>  lad_df<span class="sc">$</span>k <span class="ot">&lt;-</span> z_map[<span class="fu">as.character</span>(lad_df<span class="sc">$</span>z)]</span>
<span id="cb10-810"><a href="#cb10-810" aria-hidden="true" tabindex="-1"></a>  lad_df<span class="sc">$</span>lad_value <span class="ot">&lt;-</span> <span class="fu">round</span>(lad_df<span class="sc">$</span>lad, <span class="dv">5</span>)</span>
<span id="cb10-811"><a href="#cb10-811" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-812"><a href="#cb10-812" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Initialize XML document ---</span></span>
<span id="cb10-813"><a href="#cb10-813" aria-hidden="true" tabindex="-1"></a>  tree_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(lad_df<span class="sc">$</span>ENVIMET_ID)</span>
<span id="cb10-814"><a href="#cb10-814" aria-hidden="true" tabindex="-1"></a>  now <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%Y-%m-%dT%H:%M:%S"</span>)</span>
<span id="cb10-815"><a href="#cb10-815" aria-hidden="true" tabindex="-1"></a>  root <span class="ot">&lt;-</span> <span class="fu">newXMLNode</span>(<span class="st">"ENVI-MET_Datafile"</span>)</span>
<span id="cb10-816"><a href="#cb10-816" aria-hidden="true" tabindex="-1"></a>  header_node <span class="ot">&lt;-</span> <span class="fu">newXMLNode</span>(<span class="st">"Header"</span>)</span>
<span id="cb10-817"><a href="#cb10-817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"filetype"</span>, <span class="st">"DATA"</span>))</span>
<span id="cb10-818"><a href="#cb10-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"version"</span>, <span class="st">"1"</span>))</span>
<span id="cb10-819"><a href="#cb10-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"revisiondate"</span>, now))</span>
<span id="cb10-820"><a href="#cb10-820" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"remark"</span>, <span class="st">"Clustered TLS-based trees"</span>))</span>
<span id="cb10-821"><a href="#cb10-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"fileInfo"</span>, <span class="st">"Clustered LAD Trees"</span>))</span>
<span id="cb10-822"><a href="#cb10-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"checksum"</span>, <span class="st">"32767"</span>))</span>
<span id="cb10-823"><a href="#cb10-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(header_node, <span class="fu">newXMLNode</span>(<span class="st">"encryptionlevel"</span>, <span class="st">"1699612"</span>))</span>
<span id="cb10-824"><a href="#cb10-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addChildren</span>(root, header_node)</span>
<span id="cb10-825"><a href="#cb10-825" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-826"><a href="#cb10-826" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Iterate over all unique tree profiles ---</span></span>
<span id="cb10-827"><a href="#cb10-827" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (id <span class="cf">in</span> tree_ids) {</span>
<span id="cb10-828"><a href="#cb10-828" aria-hidden="true" tabindex="-1"></a>    tree_df <span class="ot">&lt;-</span> lad_df[lad_df<span class="sc">$</span>ENVIMET_ID <span class="sc">==</span> id, ]</span>
<span id="cb10-829"><a href="#cb10-829" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-830"><a href="#cb10-830" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average LAD across XY slices per height layer</span></span>
<span id="cb10-831"><a href="#cb10-831" aria-hidden="true" tabindex="-1"></a>    profile <span class="ot">&lt;-</span> tree_df <span class="sc">%&gt;%</span></span>
<span id="cb10-832"><a href="#cb10-832" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(<span class="at">z =</span> k) <span class="sc">%&gt;%</span></span>
<span id="cb10-833"><a href="#cb10-833" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">lad_value =</span> <span class="fu">mean</span>(lad_value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb10-834"><a href="#cb10-834" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-835"><a href="#cb10-835" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define voxel profile parameters</span></span>
<span id="cb10-836"><a href="#cb10-836" aria-hidden="true" tabindex="-1"></a>    zlayers <span class="ot">&lt;-</span> <span class="fu">max</span>(profile<span class="sc">$</span>z)</span>
<span id="cb10-837"><a href="#cb10-837" aria-hidden="true" tabindex="-1"></a>    dataI <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-838"><a href="#cb10-838" aria-hidden="true" tabindex="-1"></a>    dataJ <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-839"><a href="#cb10-839" aria-hidden="true" tabindex="-1"></a>    Height <span class="ot">&lt;-</span> zlayers <span class="sc">*</span> res_z</span>
<span id="cb10-840"><a href="#cb10-840" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-841"><a href="#cb10-841" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Default plant parameters ---</span></span>
<span id="cb10-842"><a href="#cb10-842" aria-hidden="true" tabindex="-1"></a>    name <span class="ot">&lt;-</span> <span class="st">"Fagus sylvatica"</span>; albedo <span class="ot">&lt;-</span> <span class="fl">0.18</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.30</span>; root_d <span class="ot">&lt;-</span> <span class="fl">4.5</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-843"><a href="#cb10-843" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-844"><a href="#cb10-844" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Override species traits if species_class is available ---</span></span>
<span id="cb10-845"><a href="#cb10-845" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(tree_df<span class="sc">$</span>species_class))) {</span>
<span id="cb10-846"><a href="#cb10-846" aria-hidden="true" tabindex="-1"></a>      class_val <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">unique</span>(tree_df<span class="sc">$</span>species_class))[<span class="dv">1</span>]</span>
<span id="cb10-847"><a href="#cb10-847" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">2</span>)      { name <span class="ot">&lt;-</span> <span class="st">"Alnus glutinosa"</span>;       albedo <span class="ot">&lt;-</span> <span class="fl">0.18</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.35</span>; root_d <span class="ot">&lt;-</span> <span class="fl">3.5</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">1</span> }</span>
<span id="cb10-848"><a href="#cb10-848" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">3</span>) { name <span class="ot">&lt;-</span> <span class="st">"Fraxinus excelsior"</span>;    albedo <span class="ot">&lt;-</span> <span class="fl">0.19</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.38</span>; root_d <span class="ot">&lt;-</span> <span class="fl">4.0</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">1</span> }</span>
<span id="cb10-849"><a href="#cb10-849" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">4</span>) { name <span class="ot">&lt;-</span> <span class="st">"Fagus sylvatica"</span>;       albedo <span class="ot">&lt;-</span> <span class="fl">0.18</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.30</span>; root_d <span class="ot">&lt;-</span> <span class="fl">4.5</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">1</span> }</span>
<span id="cb10-850"><a href="#cb10-850" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">5</span>) { name <span class="ot">&lt;-</span> <span class="st">"Pseudotsuga menziesii"</span>; albedo <span class="ot">&lt;-</span> <span class="fl">0.20</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.18</span>; root_d <span class="ot">&lt;-</span> <span class="fl">4.2</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">2</span> }</span>
<span id="cb10-851"><a href="#cb10-851" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">6</span>) { name <span class="ot">&lt;-</span> <span class="st">"Larix decidua"</span>;         albedo <span class="ot">&lt;-</span> <span class="fl">0.23</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.25</span>; root_d <span class="ot">&lt;-</span> <span class="fl">4.0</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">2</span> }</span>
<span id="cb10-852"><a href="#cb10-852" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">7</span>) { name <span class="ot">&lt;-</span> <span class="st">"Quercus robur"</span>;         albedo <span class="ot">&lt;-</span> <span class="fl">0.20</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.35</span>; root_d <span class="ot">&lt;-</span> <span class="fl">5.0</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">1</span> }</span>
<span id="cb10-853"><a href="#cb10-853" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (class_val <span class="sc">==</span> <span class="dv">11</span>){ name <span class="ot">&lt;-</span> <span class="st">"Picea abies"</span>;           albedo <span class="ot">&lt;-</span> <span class="fl">0.22</span>; trans <span class="ot">&lt;-</span> <span class="fl">0.15</span>; root_d <span class="ot">&lt;-</span> <span class="fl">3.0</span>; leaf_type <span class="ot">&lt;-</span> <span class="dv">2</span> }</span>
<span id="cb10-854"><a href="#cb10-854" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-855"><a href="#cb10-855" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-856"><a href="#cb10-856" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Assign seasonal profile ---</span></span>
<span id="cb10-857"><a href="#cb10-857" aria-hidden="true" tabindex="-1"></a>    profile_key <span class="ot">&lt;-</span> name</span>
<span id="cb10-858"><a href="#cb10-858" aria-hidden="true" tabindex="-1"></a>    season_profile <span class="ot">&lt;-</span> custom_profiles[[profile_key]]</span>
<span id="cb10-859"><a href="#cb10-859" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(season_profile)) {</span>
<span id="cb10-860"><a href="#cb10-860" aria-hidden="true" tabindex="-1"></a>      season_profile <span class="ot">&lt;-</span> season_profiles[[<span class="fu">ifelse</span>(leaf_type <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"broadleaf"</span>, <span class="st">"conifer"</span>)]]</span>
<span id="cb10-861"><a href="#cb10-861" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-862"><a href="#cb10-862" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-863"><a href="#cb10-863" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Build PLANT3D block ---</span></span>
<span id="cb10-864"><a href="#cb10-864" aria-hidden="true" tabindex="-1"></a>    plant_node <span class="ot">&lt;-</span> <span class="fu">newXMLNode</span>(<span class="st">"PLANT3D"</span>)</span>
<span id="cb10-865"><a href="#cb10-865" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"ID"</span>, id))</span>
<span id="cb10-866"><a href="#cb10-866" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Description"</span>, <span class="st">"Clustered TLS Tree"</span>))</span>
<span id="cb10-867"><a href="#cb10-867" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"AlternativeName"</span>, name))</span>
<span id="cb10-868"><a href="#cb10-868" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Planttype"</span>, <span class="st">"0"</span>))</span>
<span id="cb10-869"><a href="#cb10-869" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Leaftype"</span>, <span class="fu">as.character</span>(leaf_type)))</span>
<span id="cb10-870"><a href="#cb10-870" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Albedo"</span>, <span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, albedo)))</span>
<span id="cb10-871"><a href="#cb10-871" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Eps"</span>, <span class="st">"0.96000"</span>))</span>
<span id="cb10-872"><a href="#cb10-872" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Transmittance"</span>, <span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, trans)))</span>
<span id="cb10-873"><a href="#cb10-873" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Height"</span>, <span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, Height)))</span>
<span id="cb10-874"><a href="#cb10-874" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Width"</span>, <span class="st">"1.00000"</span>))</span>
<span id="cb10-875"><a href="#cb10-875" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Depth"</span>, <span class="st">"1.00000"</span>))</span>
<span id="cb10-876"><a href="#cb10-876" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"RootDiameter"</span>, <span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, root_d)))</span>
<span id="cb10-877"><a href="#cb10-877" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"cellsize"</span>, <span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, res_z)))</span>
<span id="cb10-878"><a href="#cb10-878" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"xy_cells"</span>, dataI))</span>
<span id="cb10-879"><a href="#cb10-879" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"z_cells"</span>, zlayers))</span>
<span id="cb10-880"><a href="#cb10-880" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"scalefactor"</span>, <span class="st">"1.00000"</span>))</span>
<span id="cb10-881"><a href="#cb10-881" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-882"><a href="#cb10-882" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- LAD Profile block (sparse 3D format) ---</span></span>
<span id="cb10-883"><a href="#cb10-883" aria-hidden="true" tabindex="-1"></a>    lad_lines <span class="ot">&lt;-</span> <span class="fu">apply</span>(profile, <span class="dv">1</span>, <span class="cf">function</span>(r) {</span>
<span id="cb10-884"><a href="#cb10-884" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">"%d,%d,%d,%.5f"</span>, <span class="dv">1</span>, <span class="dv">1</span>, r[<span class="dv">1</span>], r[<span class="dv">2</span>])</span>
<span id="cb10-885"><a href="#cb10-885" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-886"><a href="#cb10-886" aria-hidden="true" tabindex="-1"></a>    lad_node <span class="ot">&lt;-</span> <span class="fu">newXMLNode</span>(<span class="st">"LAD-Profile"</span>,</span>
<span id="cb10-887"><a href="#cb10-887" aria-hidden="true" tabindex="-1"></a>                           <span class="at">attrs =</span> <span class="fu">c</span>(<span class="at">type =</span> <span class="st">"sparematrix-3D"</span>,</span>
<span id="cb10-888"><a href="#cb10-888" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dataI =</span> dataI,</span>
<span id="cb10-889"><a href="#cb10-889" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dataJ =</span> dataJ,</span>
<span id="cb10-890"><a href="#cb10-890" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">zlayers =</span> zlayers,</span>
<span id="cb10-891"><a href="#cb10-891" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">defaultValue =</span> <span class="st">"0.00000"</span>),</span>
<span id="cb10-892"><a href="#cb10-892" aria-hidden="true" tabindex="-1"></a>                           <span class="at">.children =</span> <span class="fu">paste</span>(lad_lines, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb10-893"><a href="#cb10-893" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, lad_node)</span>
<span id="cb10-894"><a href="#cb10-894" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-895"><a href="#cb10-895" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Add seasonality and flowering profiles ---</span></span>
<span id="cb10-896"><a href="#cb10-896" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Season-Profile"</span>,</span>
<span id="cb10-897"><a href="#cb10-897" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">paste</span>(<span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, season_profile<span class="sc">$</span>Season), <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb10-898"><a href="#cb10-898" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"Blossom-Profile"</span>,</span>
<span id="cb10-899"><a href="#cb10-899" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">paste</span>(<span class="fu">sprintf</span>(<span class="st">"%.5f"</span>, season_profile<span class="sc">$</span>Blossom), <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb10-900"><a href="#cb10-900" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-901"><a href="#cb10-901" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Disable L-System generation ---</span></span>
<span id="cb10-902"><a href="#cb10-902" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(plant_node, <span class="fu">newXMLNode</span>(<span class="st">"L-SystemBased"</span>, <span class="st">"0"</span>))</span>
<span id="cb10-903"><a href="#cb10-903" aria-hidden="true" tabindex="-1"></a>    <span class="fu">addChildren</span>(root, plant_node)</span>
<span id="cb10-904"><a href="#cb10-904" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-905"><a href="#cb10-905" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-906"><a href="#cb10-906" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Write XML to file ---</span></span>
<span id="cb10-907"><a href="#cb10-907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveXML</span>(root, <span class="at">file =</span> file_out, <span class="at">indent =</span> <span class="cn">TRUE</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb10-908"><a href="#cb10-908" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"✔ ENVI-met PLANT3D (.pld) written to: "</span>, <span class="fu">normalizePath</span>(file_out))</span>
<span id="cb10-909"><a href="#cb10-909" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-910"><a href="#cb10-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-911"><a href="#cb10-911" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generate Compact ENVI-met-Compatible Base36 String IDs</span></span>
<span id="cb10-912"><a href="#cb10-912" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-913"><a href="#cb10-913" aria-hidden="true" tabindex="-1"></a><span class="co">#' Converts an integer index to a left-padded base-36 string (digits + uppercase A–Z),</span></span>
<span id="cb10-914"><a href="#cb10-914" aria-hidden="true" tabindex="-1"></a><span class="co">#' prefixed with `"S"`, suitable for use as compact `ENVIMET_ID`s (e.g., `"S0001A"`).</span></span>
<span id="cb10-915"><a href="#cb10-915" aria-hidden="true" tabindex="-1"></a><span class="co">#' Useful when assigning unique but readable identifiers for synthetic plant elements</span></span>
<span id="cb10-916"><a href="#cb10-916" aria-hidden="true" tabindex="-1"></a><span class="co">#' in 3D simulation domains.</span></span>
<span id="cb10-917"><a href="#cb10-917" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-918"><a href="#cb10-918" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n An integer (scalar) to convert to base-36.</span></span>
<span id="cb10-919"><a href="#cb10-919" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param width Integer width of the resulting code (default: 5). Strings are zero-padded on the left.</span></span>
<span id="cb10-920"><a href="#cb10-920" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-921"><a href="#cb10-921" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A character string in base-36 representation, prefixed with `"S"` and left-padded</span></span>
<span id="cb10-922"><a href="#cb10-922" aria-hidden="true" tabindex="-1"></a><span class="co">#' to match the desired `width`. Returns e.g. `"S0000A"`, `"S0001Z"`, `"S00010"`, etc.</span></span>
<span id="cb10-923"><a href="#cb10-923" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-924"><a href="#cb10-924" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-925"><a href="#cb10-925" aria-hidden="true" tabindex="-1"></a><span class="co">#' Base-36 encoding uses the characters `0–9` and `A–Z` to represent numbers in a compact alphanumeric form.</span></span>
<span id="cb10-926"><a href="#cb10-926" aria-hidden="true" tabindex="-1"></a><span class="co">#' This is commonly used in modeling frameworks like ENVI-met where short string IDs are needed to:</span></span>
<span id="cb10-927"><a href="#cb10-927" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Uniquely label plant objects (`ENVIMET_ID`)</span></span>
<span id="cb10-928"><a href="#cb10-928" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Avoid numeric-only names (which may conflict with XML or database formats)</span></span>
<span id="cb10-929"><a href="#cb10-929" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Allow for high capacity in short formats (36⁵ = ~60 million unique IDs for `width = 5`)</span></span>
<span id="cb10-930"><a href="#cb10-930" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-931"><a href="#cb10-931" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function:</span></span>
<span id="cb10-932"><a href="#cb10-932" aria-hidden="true" tabindex="-1"></a><span class="co">#' 1. Converts the number `n` to base-36 using digit/modulo arithmetic</span></span>
<span id="cb10-933"><a href="#cb10-933" aria-hidden="true" tabindex="-1"></a><span class="co">#' 2. Left-pads the result to fixed width with zeros (`"0"`)</span></span>
<span id="cb10-934"><a href="#cb10-934" aria-hidden="true" tabindex="-1"></a><span class="co">#' 3. Adds a prefix `"S"` to ensure the string starts with a non-numeric character</span></span>
<span id="cb10-935"><a href="#cb10-935" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-936"><a href="#cb10-936" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note</span></span>
<span id="cb10-937"><a href="#cb10-937" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function assumes positive integers (`n &gt; 0`). No validation is done for negative or non-integer input.</span></span>
<span id="cb10-938"><a href="#cb10-938" aria-hidden="true" tabindex="-1"></a><span class="co">#' It is up to the user to avoid duplicate IDs.</span></span>
<span id="cb10-939"><a href="#cb10-939" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-940"><a href="#cb10-940" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso</span></span>
<span id="cb10-941"><a href="#cb10-941" aria-hidden="true" tabindex="-1"></a><span class="co">#' [export_lad_to_envimet_p3d()], [sprintf()], [strtoi()] for inverse conversion</span></span>
<span id="cb10-942"><a href="#cb10-942" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-943"><a href="#cb10-943" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-944"><a href="#cb10-944" aria-hidden="true" tabindex="-1"></a><span class="co">#' int_to_base36(1)      # "S00001"</span></span>
<span id="cb10-945"><a href="#cb10-945" aria-hidden="true" tabindex="-1"></a><span class="co">#' int_to_base36(35)     # "S0000Z"</span></span>
<span id="cb10-946"><a href="#cb10-946" aria-hidden="true" tabindex="-1"></a><span class="co">#' int_to_base36(36)     # "S00010"</span></span>
<span id="cb10-947"><a href="#cb10-947" aria-hidden="true" tabindex="-1"></a><span class="co">#' int_to_base36(12345)  # "S009IX"</span></span>
<span id="cb10-948"><a href="#cb10-948" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-949"><a href="#cb10-949" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-950"><a href="#cb10-950" aria-hidden="true" tabindex="-1"></a>int_to_base36 <span class="ot">&lt;-</span> <span class="cf">function</span>(n, <span class="at">width =</span> <span class="dv">5</span>) {</span>
<span id="cb10-951"><a href="#cb10-951" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Base-36 character set: 0–9, A–Z</span></span>
<span id="cb10-952"><a href="#cb10-952" aria-hidden="true" tabindex="-1"></a>  chars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, LETTERS)</span>
<span id="cb10-953"><a href="#cb10-953" aria-hidden="true" tabindex="-1"></a>  base <span class="ot">&lt;-</span> <span class="fu">length</span>(chars)</span>
<span id="cb10-954"><a href="#cb10-954" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-955"><a href="#cb10-955" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to base-36 via division/remainder</span></span>
<span id="cb10-956"><a href="#cb10-956" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb10-957"><a href="#cb10-957" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (n <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-958"><a href="#cb10-958" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">c</span>(chars[(n <span class="sc">%%</span> base) <span class="sc">+</span> <span class="dv">1</span>], result)</span>
<span id="cb10-959"><a href="#cb10-959" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> n <span class="sc">%/%</span> base</span>
<span id="cb10-960"><a href="#cb10-960" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-961"><a href="#cb10-961" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-962"><a href="#cb10-962" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Collapse to single string</span></span>
<span id="cb10-963"><a href="#cb10-963" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">paste</span>(result, <span class="at">collapse =</span> <span class="st">""</span>)</span>
<span id="cb10-964"><a href="#cb10-964" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-965"><a href="#cb10-965" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pad with zeros on the left to match width</span></span>
<span id="cb10-966"><a href="#cb10-966" aria-hidden="true" tabindex="-1"></a>  padded <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="fu">paste0</span>(<span class="st">"%0"</span>, width, <span class="st">"s"</span>), result)</span>
<span id="cb10-967"><a href="#cb10-967" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-968"><a href="#cb10-968" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Replace spaces with "0" and add "S" prefix</span></span>
<span id="cb10-969"><a href="#cb10-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"S"</span>, <span class="fu">substr</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"0"</span>, padded), <span class="dv">1</span>, width))</span>
<span id="cb10-970"><a href="#cb10-970" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-971"><a href="#cb10-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-972"><a href="#cb10-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-973"><a href="#cb10-973" aria-hidden="true" tabindex="-1"></a><span class="co">#' Suggest Optimal Number of Principal Components</span></span>
<span id="cb10-974"><a href="#cb10-974" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-975"><a href="#cb10-975" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function evaluates a PCA object and recommends the number of components to retain</span></span>
<span id="cb10-976"><a href="#cb10-976" aria-hidden="true" tabindex="-1"></a><span class="co">#' based on three common criteria: cumulative explained variance, Kaiser criterion, and the</span></span>
<span id="cb10-977"><a href="#cb10-977" aria-hidden="true" tabindex="-1"></a><span class="co">#' elbow method. Optionally, a diagnostic scree plot and cumulative variance plot are shown.</span></span>
<span id="cb10-978"><a href="#cb10-978" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-979"><a href="#cb10-979" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pca_obj A PCA object as returned by [prcomp()], which must contain the `sdev` vector.</span></span>
<span id="cb10-980"><a href="#cb10-980" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param variance_cutoff The cumulative explained variance threshold to use for the primary selection (default: 0.8).</span></span>
<span id="cb10-981"><a href="#cb10-981" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param plot Logical. If `TRUE`, produces a scree plot and a cumulative variance plot for visual inspection.</span></span>
<span id="cb10-982"><a href="#cb10-982" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-983"><a href="#cb10-983" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list with the following elements:</span></span>
<span id="cb10-984"><a href="#cb10-984" aria-hidden="true" tabindex="-1"></a><span class="co">#' \describe{</span></span>
<span id="cb10-985"><a href="#cb10-985" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{n_pcs}{Recommended number of principal components based on variance cutoff.}</span></span>
<span id="cb10-986"><a href="#cb10-986" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{explained_variance}{Number of components needed to reach the cutoff.}</span></span>
<span id="cb10-987"><a href="#cb10-987" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{kaiser}{Number of components with eigenvalue &gt; 1 (Kaiser criterion).}</span></span>
<span id="cb10-988"><a href="#cb10-988" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{elbow}{Index of the "elbow" point in the scree plot.}</span></span>
<span id="cb10-989"><a href="#cb10-989" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item{info_table}{A summary data frame showing results for all three criteria.}</span></span>
<span id="cb10-990"><a href="#cb10-990" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-991"><a href="#cb10-991" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-992"><a href="#cb10-992" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-993"><a href="#cb10-993" aria-hidden="true" tabindex="-1"></a><span class="co">#' The number of principal components can be selected using multiple heuristics:</span></span>
<span id="cb10-994"><a href="#cb10-994" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-995"><a href="#cb10-995" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Cumulative Explained Variance**: Retain the smallest number of components such that the</span></span>
<span id="cb10-996"><a href="#cb10-996" aria-hidden="true" tabindex="-1"></a><span class="co">#' cumulative variance exceeds `variance_cutoff`. This is often considered the primary criterion.</span></span>
<span id="cb10-997"><a href="#cb10-997" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-998"><a href="#cb10-998" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Kaiser Criterion**: Retain all components with eigenvalue &gt; 1. Assumes input data has been scaled.</span></span>
<span id="cb10-999"><a href="#cb10-999" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1000"><a href="#cb10-1000" aria-hidden="true" tabindex="-1"></a><span class="co">#' - **Elbow Method**: Identifies the point where the marginal gain in explained variance drops off,</span></span>
<span id="cb10-1001"><a href="#cb10-1001" aria-hidden="true" tabindex="-1"></a><span class="co">#' i.e., the inflection point of the scree plot. Here approximated by the first minimum in the</span></span>
<span id="cb10-1002"><a href="#cb10-1002" aria-hidden="true" tabindex="-1"></a><span class="co">#' differences of explained variance.</span></span>
<span id="cb10-1003"><a href="#cb10-1003" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1004"><a href="#cb10-1004" aria-hidden="true" tabindex="-1"></a><span class="co">#' The function outputs all three estimates but uses only the **variance cutoff** for final selection.</span></span>
<span id="cb10-1005"><a href="#cb10-1005" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1006"><a href="#cb10-1006" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note</span></span>
<span id="cb10-1007"><a href="#cb10-1007" aria-hidden="true" tabindex="-1"></a><span class="co">#' The scree plot assumes components are sorted by variance (as returned by [prcomp()]).</span></span>
<span id="cb10-1008"><a href="#cb10-1008" aria-hidden="true" tabindex="-1"></a><span class="co">#' The elbow method used here is a simplified heuristic and may not capture complex knees.</span></span>
<span id="cb10-1009"><a href="#cb10-1009" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1010"><a href="#cb10-1010" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso</span></span>
<span id="cb10-1011"><a href="#cb10-1011" aria-hidden="true" tabindex="-1"></a><span class="co">#' [prcomp()], [factoextra::fviz_eig()], [psych::principal()]</span></span>
<span id="cb10-1012"><a href="#cb10-1012" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1013"><a href="#cb10-1013" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-1014"><a href="#cb10-1014" aria-hidden="true" tabindex="-1"></a><span class="co">#' pca &lt;- prcomp(USArrests, scale. = TRUE)</span></span>
<span id="cb10-1015"><a href="#cb10-1015" aria-hidden="true" tabindex="-1"></a><span class="co">#' suggest_n_pcs(pca, variance_cutoff = 0.9)</span></span>
<span id="cb10-1016"><a href="#cb10-1016" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1017"><a href="#cb10-1017" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-1018"><a href="#cb10-1018" aria-hidden="true" tabindex="-1"></a>suggest_n_pcs <span class="ot">&lt;-</span> <span class="cf">function</span>(pca_obj, <span class="at">variance_cutoff =</span> <span class="fl">0.8</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb10-1019"><a href="#cb10-1019" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract standard deviations and calculate explained variance</span></span>
<span id="cb10-1020"><a href="#cb10-1020" aria-hidden="true" tabindex="-1"></a>  std_dev <span class="ot">&lt;-</span> pca_obj<span class="sc">$</span>sdev</span>
<span id="cb10-1021"><a href="#cb10-1021" aria-hidden="true" tabindex="-1"></a>  var_explained <span class="ot">&lt;-</span> std_dev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(std_dev<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-1022"><a href="#cb10-1022" aria-hidden="true" tabindex="-1"></a>  cum_var_explained <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(var_explained)</span>
<span id="cb10-1023"><a href="#cb10-1023" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1024"><a href="#cb10-1024" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Criterion 1: variance cutoff</span></span>
<span id="cb10-1025"><a href="#cb10-1025" aria-hidden="true" tabindex="-1"></a>  n_var <span class="ot">&lt;-</span> <span class="fu">which</span>(cum_var_explained <span class="sc">&gt;=</span> variance_cutoff)[<span class="dv">1</span>]</span>
<span id="cb10-1026"><a href="#cb10-1026" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1027"><a href="#cb10-1027" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Criterion 2: Kaiser criterion (eigenvalue &gt; 1)</span></span>
<span id="cb10-1028"><a href="#cb10-1028" aria-hidden="true" tabindex="-1"></a>  eigenvalues <span class="ot">&lt;-</span> std_dev<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb10-1029"><a href="#cb10-1029" aria-hidden="true" tabindex="-1"></a>  n_kaiser <span class="ot">&lt;-</span> <span class="fu">sum</span>(eigenvalues <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb10-1030"><a href="#cb10-1030" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1031"><a href="#cb10-1031" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Criterion 3: elbow (minimum change in explained variance)</span></span>
<span id="cb10-1032"><a href="#cb10-1032" aria-hidden="true" tabindex="-1"></a>  diffs <span class="ot">&lt;-</span> <span class="fu">diff</span>(var_explained)</span>
<span id="cb10-1033"><a href="#cb10-1033" aria-hidden="true" tabindex="-1"></a>  elbow <span class="ot">&lt;-</span> <span class="fu">which.min</span>(diffs)[<span class="dv">1</span>]</span>
<span id="cb10-1034"><a href="#cb10-1034" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1035"><a href="#cb10-1035" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summarize selection criteria</span></span>
<span id="cb10-1036"><a href="#cb10-1036" aria-hidden="true" tabindex="-1"></a>  info_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-1037"><a href="#cb10-1037" aria-hidden="true" tabindex="-1"></a>    <span class="at">Criterion =</span> <span class="fu">c</span>(<span class="st">"Variance Cutoff"</span>, <span class="st">"Kaiser Criterion"</span>, <span class="st">"Elbow Method"</span>),</span>
<span id="cb10-1038"><a href="#cb10-1038" aria-hidden="true" tabindex="-1"></a>    <span class="at">Components =</span> <span class="fu">c</span>(n_var, n_kaiser, elbow),</span>
<span id="cb10-1039"><a href="#cb10-1039" aria-hidden="true" tabindex="-1"></a>    <span class="at">Cumulative_Variance =</span> <span class="fu">c</span>(</span>
<span id="cb10-1040"><a href="#cb10-1040" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(cum_var_explained[n_var], <span class="dv">3</span>),</span>
<span id="cb10-1041"><a href="#cb10-1041" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(cum_var_explained[n_kaiser], <span class="dv">3</span>),</span>
<span id="cb10-1042"><a href="#cb10-1042" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(cum_var_explained[elbow], <span class="dv">3</span>)</span>
<span id="cb10-1043"><a href="#cb10-1043" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-1044"><a href="#cb10-1044" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-1045"><a href="#cb10-1045" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1046"><a href="#cb10-1046" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Final decision based on variance criterion only</span></span>
<span id="cb10-1047"><a href="#cb10-1047" aria-hidden="true" tabindex="-1"></a>  n_final <span class="ot">&lt;-</span> n_var</span>
<span id="cb10-1048"><a href="#cb10-1048" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1049"><a href="#cb10-1049" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output summary</span></span>
<span id="cb10-1050"><a href="#cb10-1050" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"📊 PCA Component Selection Summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-1051"><a href="#cb10-1051" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(info_table, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-1052"><a href="#cb10-1052" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">✅ Recommended number of PCs (variance_cutoff ="</span>, variance_cutoff, <span class="st">"):"</span>, n_final, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-1053"><a href="#cb10-1053" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1054"><a href="#cb10-1054" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional visualization</span></span>
<span id="cb10-1055"><a href="#cb10-1055" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (plot) {</span>
<span id="cb10-1056"><a href="#cb10-1056" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb10-1057"><a href="#cb10-1057" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-1058"><a href="#cb10-1058" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scree plot</span></span>
<span id="cb10-1059"><a href="#cb10-1059" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(var_explained, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"steelblue"</span>,</span>
<span id="cb10-1060"><a href="#cb10-1060" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab =</span> <span class="st">"Component"</span>, <span class="at">ylab =</span> <span class="st">"Explained Variance"</span>,</span>
<span id="cb10-1061"><a href="#cb10-1061" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">"Scree Plot"</span>)</span>
<span id="cb10-1062"><a href="#cb10-1062" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb10-1063"><a href="#cb10-1063" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> elbow, <span class="at">col =</span> <span class="st">"darkgreen"</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span>
<span id="cb10-1064"><a href="#cb10-1064" aria-hidden="true" tabindex="-1"></a>    <span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Kaiser (λ &gt; 1)"</span>, <span class="st">"Elbow"</span>),</span>
<span id="cb10-1065"><a href="#cb10-1065" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"darkgreen"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb10-1066"><a href="#cb10-1066" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-1067"><a href="#cb10-1067" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative variance plot</span></span>
<span id="cb10-1068"><a href="#cb10-1068" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(cum_var_explained, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"darkorange"</span>,</span>
<span id="cb10-1069"><a href="#cb10-1069" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab =</span> <span class="st">"Component"</span>, <span class="at">ylab =</span> <span class="st">"Cumulative Variance"</span>,</span>
<span id="cb10-1070"><a href="#cb10-1070" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">"Cumulative Explained Variance"</span>)</span>
<span id="cb10-1071"><a href="#cb10-1071" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">h =</span> variance_cutoff, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb10-1072"><a href="#cb10-1072" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abline</span>(<span class="at">v =</span> n_var, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">3</span>)</span>
<span id="cb10-1073"><a href="#cb10-1073" aria-hidden="true" tabindex="-1"></a>    <span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Cutoff"</span>, <span class="st">"Selected Components"</span>),</span>
<span id="cb10-1074"><a href="#cb10-1074" aria-hidden="true" tabindex="-1"></a>           <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="at">bty =</span> <span class="st">"n"</span>)</span>
<span id="cb10-1075"><a href="#cb10-1075" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-1076"><a href="#cb10-1076" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb10-1077"><a href="#cb10-1077" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-1078"><a href="#cb10-1078" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1079"><a href="#cb10-1079" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return results invisibly</span></span>
<span id="cb10-1080"><a href="#cb10-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="fu">list</span>(</span>
<span id="cb10-1081"><a href="#cb10-1081" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pcs =</span> n_final,</span>
<span id="cb10-1082"><a href="#cb10-1082" aria-hidden="true" tabindex="-1"></a>    <span class="at">explained_variance =</span> n_var,</span>
<span id="cb10-1083"><a href="#cb10-1083" aria-hidden="true" tabindex="-1"></a>    <span class="at">kaiser =</span> n_kaiser,</span>
<span id="cb10-1084"><a href="#cb10-1084" aria-hidden="true" tabindex="-1"></a>    <span class="at">elbow =</span> elbow,</span>
<span id="cb10-1085"><a href="#cb10-1085" aria-hidden="true" tabindex="-1"></a>    <span class="at">info_table =</span> info_table</span>
<span id="cb10-1086"><a href="#cb10-1086" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb10-1087"><a href="#cb10-1087" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-1088"><a href="#cb10-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1089"><a href="#cb10-1089" aria-hidden="true" tabindex="-1"></a><span class="co">#' Export ENVI-met 3DPLANT XML from enriched LAD profile dataframe</span></span>
<span id="cb10-1090"><a href="#cb10-1090" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1091"><a href="#cb10-1091" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function prepares and exports an ENVI-met compatible 3DPLANT (.pld) XML file</span></span>
<span id="cb10-1092"><a href="#cb10-1092" aria-hidden="true" tabindex="-1"></a><span class="co">#' using a fully enriched `lad_df_cleaned` dataframe, containing LAD profiles, traits,</span></span>
<span id="cb10-1093"><a href="#cb10-1093" aria-hidden="true" tabindex="-1"></a><span class="co">#' and metadata for each ENVIMET_ID.</span></span>
<span id="cb10-1094"><a href="#cb10-1094" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1095"><a href="#cb10-1095" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_df_cleaned A data.frame containing voxelized LAD data and associated plant traits.</span></span>
<span id="cb10-1096"><a href="#cb10-1096" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Must contain: `ENVIMET_ID`, `cluster`, `z`, `lad`, `species_class`, `species_name`,</span></span>
<span id="cb10-1097"><a href="#cb10-1097" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `LeafThickness`, `Height_CHM`, `Vertical_Evenness`, `Entropy`, `RoughnessLength`,</span></span>
<span id="cb10-1098"><a href="#cb10-1098" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `LAI`, `MaxLAD`, `CrownHeight`, `Height`, `LADcutoff`, `plantclass`.</span></span>
<span id="cb10-1099"><a href="#cb10-1099" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param file_out Path to output `.pld` file.</span></span>
<span id="cb10-1100"><a href="#cb10-1100" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res_z Vertical voxel resolution in meters (e.g. 2).</span></span>
<span id="cb10-1101"><a href="#cb10-1101" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1102"><a href="#cb10-1102" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Invisible `TRUE` if export succeeds, otherwise stops with an error.</span></span>
<span id="cb10-1103"><a href="#cb10-1103" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-1104"><a href="#cb10-1104" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1105"><a href="#cb10-1105" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-1106"><a href="#cb10-1106" aria-hidden="true" tabindex="-1"></a><span class="co">#' export_envimet_pld_from_lad_clean(</span></span>
<span id="cb10-1107"><a href="#cb10-1107" aria-hidden="true" tabindex="-1"></a><span class="co">#'   lad_df_cleaned = lad_profiles_long,</span></span>
<span id="cb10-1108"><a href="#cb10-1108" aria-hidden="true" tabindex="-1"></a><span class="co">#'   file_out = "data/envimet/envimet_pseudo3Dtree.pld",</span></span>
<span id="cb10-1109"><a href="#cb10-1109" aria-hidden="true" tabindex="-1"></a><span class="co">#'   res_z = 2</span></span>
<span id="cb10-1110"><a href="#cb10-1110" aria-hidden="true" tabindex="-1"></a><span class="co">#' )</span></span>
<span id="cb10-1111"><a href="#cb10-1111" aria-hidden="true" tabindex="-1"></a>export_envimet_pld_from_lad_clean <span class="ot">&lt;-</span> <span class="cf">function</span>(lad_df_cleaned, file_out, res_z) {</span>
<span id="cb10-1112"><a href="#cb10-1112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1113"><a href="#cb10-1113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Validation of required columns ---</span></span>
<span id="cb10-1114"><a href="#cb10-1114" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-1115"><a href="#cb10-1115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ENVIMET_ID"</span>, <span class="st">"cluster"</span>, <span class="st">"z"</span>, <span class="st">"lad"</span>,</span>
<span id="cb10-1116"><a href="#cb10-1116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"species_class"</span>, <span class="st">"species_name"</span>, <span class="st">"LeafThickness"</span>,</span>
<span id="cb10-1117"><a href="#cb10-1117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Height_CHM"</span>, <span class="st">"Vertical_Evenness"</span>, <span class="st">"Entropy"</span>,</span>
<span id="cb10-1118"><a href="#cb10-1118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RoughnessLength"</span>, <span class="st">"LAI"</span>, <span class="st">"MaxLAD"</span>,</span>
<span id="cb10-1119"><a href="#cb10-1119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CrownHeight"</span>, <span class="st">"Height"</span>, <span class="st">"LADcutoff"</span>, <span class="st">"plantclass"</span></span>
<span id="cb10-1120"><a href="#cb10-1120" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-1121"><a href="#cb10-1121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1122"><a href="#cb10-1122" aria-hidden="true" tabindex="-1"></a>  missing <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(required_cols, <span class="fu">colnames</span>(lad_df_cleaned))</span>
<span id="cb10-1123"><a href="#cb10-1123" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(missing) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-1124"><a href="#cb10-1124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Missing columns in lad_df_cleaned: "</span>, <span class="fu">paste</span>(missing, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb10-1125"><a href="#cb10-1125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-1126"><a href="#cb10-1126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1127"><a href="#cb10-1127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Ensure required columns are complete ---</span></span>
<span id="cb10-1128"><a href="#cb10-1128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(lad_df_cleaned<span class="sc">$</span>ENVIMET_ID)))</span>
<span id="cb10-1129"><a href="#cb10-1129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(lad_df_cleaned<span class="sc">$</span>lad)))</span>
<span id="cb10-1130"><a href="#cb10-1130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(lad_df_cleaned<span class="sc">$</span>species_name)))</span>
<span id="cb10-1131"><a href="#cb10-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(lad_df_cleaned<span class="sc">$</span>LeafThickness)))</span>
<span id="cb10-1132"><a href="#cb10-1132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1133"><a href="#cb10-1133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Extract trait table (one row per plant ID) ---</span></span>
<span id="cb10-1134"><a href="#cb10-1134" aria-hidden="true" tabindex="-1"></a>  trait_df <span class="ot">&lt;-</span> lad_df_cleaned <span class="sc">%&gt;%</span></span>
<span id="cb10-1135"><a href="#cb10-1135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(ENVIMET_ID) <span class="sc">%&gt;%</span></span>
<span id="cb10-1136"><a href="#cb10-1136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb10-1137"><a href="#cb10-1137" aria-hidden="true" tabindex="-1"></a>      <span class="at">LAI =</span> <span class="fu">mean</span>(LAI, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1138"><a href="#cb10-1138" aria-hidden="true" tabindex="-1"></a>      <span class="at">MaxLAD =</span> <span class="fu">max</span>(MaxLAD, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1139"><a href="#cb10-1139" aria-hidden="true" tabindex="-1"></a>      <span class="at">CrownHeight =</span> <span class="fu">mean</span>(CrownHeight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1140"><a href="#cb10-1140" aria-hidden="true" tabindex="-1"></a>      <span class="at">Height =</span> <span class="fu">mean</span>(Height, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1141"><a href="#cb10-1141" aria-hidden="true" tabindex="-1"></a>      <span class="at">RoughnessLength =</span> <span class="fu">mean</span>(RoughnessLength, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1142"><a href="#cb10-1142" aria-hidden="true" tabindex="-1"></a>      <span class="at">LeafThickness =</span> <span class="fu">mean</span>(LeafThickness, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1143"><a href="#cb10-1143" aria-hidden="true" tabindex="-1"></a>      <span class="at">LADcutoff =</span> <span class="fu">mean</span>(LADcutoff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1144"><a href="#cb10-1144" aria-hidden="true" tabindex="-1"></a>      <span class="at">plantclass =</span> <span class="fu">first</span>(plantclass),</span>
<span id="cb10-1145"><a href="#cb10-1145" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_class =</span> <span class="fu">first</span>(species_class),</span>
<span id="cb10-1146"><a href="#cb10-1146" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_name =</span> <span class="fu">first</span>(species_name),</span>
<span id="cb10-1147"><a href="#cb10-1147" aria-hidden="true" tabindex="-1"></a>      <span class="at">Entropy =</span> <span class="fu">mean</span>(Entropy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1148"><a href="#cb10-1148" aria-hidden="true" tabindex="-1"></a>      <span class="at">Vertical_Evenness =</span> <span class="fu">mean</span>(Vertical_Evenness, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1149"><a href="#cb10-1149" aria-hidden="true" tabindex="-1"></a>      <span class="at">Height_CHM =</span> <span class="fu">mean</span>(Height_CHM, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-1150"><a href="#cb10-1150" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb10-1151"><a href="#cb10-1151" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb10-1152"><a href="#cb10-1152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(LAI), <span class="sc">!</span><span class="fu">is.na</span>(MaxLAD))</span>
<span id="cb10-1153"><a href="#cb10-1153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1154"><a href="#cb10-1154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Filter valid LAD entries ---</span></span>
<span id="cb10-1155"><a href="#cb10-1155" aria-hidden="true" tabindex="-1"></a>  valid_ids <span class="ot">&lt;-</span> trait_df<span class="sc">$</span>ENVIMET_ID</span>
<span id="cb10-1156"><a href="#cb10-1156" aria-hidden="true" tabindex="-1"></a>  lad_profiles_filtered <span class="ot">&lt;-</span> lad_df_cleaned <span class="sc">%&gt;%</span></span>
<span id="cb10-1157"><a href="#cb10-1157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ENVIMET_ID <span class="sc">%in%</span> valid_ids)</span>
<span id="cb10-1158"><a href="#cb10-1158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1159"><a href="#cb10-1159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Export via custom XML function ---</span></span>
<span id="cb10-1160"><a href="#cb10-1160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">export_lad_to_envimet_p3d</span>(</span>
<span id="cb10-1161"><a href="#cb10-1161" aria-hidden="true" tabindex="-1"></a>    <span class="at">lad_df =</span> lad_profiles_filtered,</span>
<span id="cb10-1162"><a href="#cb10-1162" aria-hidden="true" tabindex="-1"></a>    <span class="at">file_out =</span> file_out,</span>
<span id="cb10-1163"><a href="#cb10-1163" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_z =</span> res_z,</span>
<span id="cb10-1164"><a href="#cb10-1164" aria-hidden="true" tabindex="-1"></a>    <span class="at">trait_df =</span> trait_df</span>
<span id="cb10-1165"><a href="#cb10-1165" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-1166"><a href="#cb10-1166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1167"><a href="#cb10-1167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(<span class="cn">TRUE</span>)</span>
<span id="cb10-1168"><a href="#cb10-1168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-1169"><a href="#cb10-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1170"><a href="#cb10-1170" aria-hidden="true" tabindex="-1"></a><span class="co">#' Export ENVI-met and microclimf LAD Profiles from Clustered Data</span></span>
<span id="cb10-1171"><a href="#cb10-1171" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1172"><a href="#cb10-1172" aria-hidden="true" tabindex="-1"></a><span class="co">#' These functions aggregate a cleaned LAD dataset (lad_df_clean) by cluster,</span></span>
<span id="cb10-1173"><a href="#cb10-1173" aria-hidden="true" tabindex="-1"></a><span class="co">#' compute synthetic profiles, and export them for use in ENVI-met and microclimf.</span></span>
<span id="cb10-1174"><a href="#cb10-1174" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1175"><a href="#cb10-1175" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_df_clean Data frame with full LAD profile, coordinates, traits, and cluster ID.</span></span>
<span id="cb10-1176"><a href="#cb10-1176" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param res_z Vertical voxel resolution (numeric).</span></span>
<span id="cb10-1177"><a href="#cb10-1177" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param out_dir Output directory where .gpkg and .pld files will be written.</span></span>
<span id="cb10-1178"><a href="#cb10-1178" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-1179"><a href="#cb10-1179" aria-hidden="true" tabindex="-1"></a>export_envimet_profiles <span class="ot">&lt;-</span> <span class="cf">function</span>(lad_df_clean, res_z, <span class="at">out_dir =</span> <span class="st">"data/envimet"</span>) {</span>
<span id="cb10-1180"><a href="#cb10-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(out_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-1181"><a href="#cb10-1181" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1182"><a href="#cb10-1182" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Mittelung der LAD-Profile nach Cluster ---</span></span>
<span id="cb10-1183"><a href="#cb10-1183" aria-hidden="true" tabindex="-1"></a>  cluster_profiles <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb10-1184"><a href="#cb10-1184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb10-1185"><a href="#cb10-1185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"lad_pulses_"</span>), <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1186"><a href="#cb10-1186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(cluster)</span>
<span id="cb10-1187"><a href="#cb10-1187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1188"><a href="#cb10-1188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Long-Format ---</span></span>
<span id="cb10-1189"><a href="#cb10-1189" aria-hidden="true" tabindex="-1"></a>  lad_profiles_long <span class="ot">&lt;-</span> cluster_profiles <span class="sc">%&gt;%</span></span>
<span id="cb10-1190"><a href="#cb10-1190" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"lad_pulses_"</span>),</span>
<span id="cb10-1191"><a href="#cb10-1191" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"layer"</span>, <span class="at">values_to =</span> <span class="st">"lad"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1192"><a href="#cb10-1192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">z =</span> <span class="fu">as.integer</span>(<span class="fu">gsub</span>(<span class="st">"lad_pulses_|_.*"</span>, <span class="st">""</span>, layer)) <span class="sc">*</span> res_z,</span>
<span id="cb10-1193"><a href="#cb10-1193" aria-hidden="true" tabindex="-1"></a>           <span class="at">ENVIMET_ID =</span> <span class="fu">paste0</span>(<span class="st">"S"</span>, <span class="fu">formatC</span>(cluster, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">flag =</span> <span class="st">"0"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb10-1194"><a href="#cb10-1194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(ENVIMET_ID, cluster, z, lad)</span>
<span id="cb10-1195"><a href="#cb10-1195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1196"><a href="#cb10-1196" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Art und Traits ---</span></span>
<span id="cb10-1197"><a href="#cb10-1197" aria-hidden="true" tabindex="-1"></a>  cluster_traits <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb10-1198"><a href="#cb10-1198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster, species_class) <span class="sc">%&gt;%</span></span>
<span id="cb10-1199"><a href="#cb10-1199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1200"><a href="#cb10-1200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb10-1201"><a href="#cb10-1201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_max</span>(n, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1202"><a href="#cb10-1202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb10-1203"><a href="#cb10-1203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1204"><a href="#cb10-1204" aria-hidden="true" tabindex="-1"></a>  species_mapping <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb10-1205"><a href="#cb10-1205" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_class =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>),</span>
<span id="cb10-1206"><a href="#cb10-1206" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name =</span> <span class="fu">c</span>(<span class="st">"Acer pseudoplatanus"</span>, <span class="st">"Betula pendula"</span>, <span class="st">"Fagus sylvatica"</span>,</span>
<span id="cb10-1207"><a href="#cb10-1207" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Picea abies"</span>, <span class="st">"Pinus sylvestris"</span>, <span class="st">"Quercus robur"</span>, <span class="st">"Tilia cordata"</span>)</span>
<span id="cb10-1208"><a href="#cb10-1208" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-1209"><a href="#cb10-1209" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1210"><a href="#cb10-1210" aria-hidden="true" tabindex="-1"></a>  leaf_thickness_lookup <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb10-1211"><a href="#cb10-1211" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name =</span> <span class="fu">c</span>(<span class="st">"Fagus sylvatica"</span>, <span class="st">"Quercus robur"</span>, <span class="st">"Acer pseudoplatanus"</span>,</span>
<span id="cb10-1212"><a href="#cb10-1212" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Pinus sylvestris"</span>, <span class="st">"Picea abies"</span>, <span class="st">"Betula pendula"</span>, <span class="st">"Tilia cordata"</span>),</span>
<span id="cb10-1213"><a href="#cb10-1213" aria-hidden="true" tabindex="-1"></a>    <span class="at">LeafThickness =</span> <span class="fu">c</span>(<span class="fl">0.0025</span>, <span class="fl">0.0025</span>, <span class="fl">0.0022</span>, <span class="fl">0.0015</span>, <span class="fl">0.0016</span>, <span class="fl">0.0021</span>, <span class="fl">0.0023</span>)</span>
<span id="cb10-1214"><a href="#cb10-1214" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-1215"><a href="#cb10-1215" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1216"><a href="#cb10-1216" aria-hidden="true" tabindex="-1"></a>  cluster_heights <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb10-1217"><a href="#cb10-1217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb10-1218"><a href="#cb10-1218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Height =</span> <span class="fu">mean</span>(CHM, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb10-1219"><a href="#cb10-1219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1220"><a href="#cb10-1220" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- LAD-Profile anreichern ---</span></span>
<span id="cb10-1221"><a href="#cb10-1221" aria-hidden="true" tabindex="-1"></a>  lad_profiles_long <span class="ot">&lt;-</span> lad_profiles_long <span class="sc">%&gt;%</span></span>
<span id="cb10-1222"><a href="#cb10-1222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(cluster_traits, <span class="at">by =</span> <span class="st">"cluster"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1223"><a href="#cb10-1223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(species_mapping, <span class="at">by =</span> <span class="st">"species_class"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1224"><a href="#cb10-1224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(leaf_thickness_lookup, <span class="at">by =</span> <span class="st">"species_name"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1225"><a href="#cb10-1225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(cluster_heights, <span class="at">by =</span> <span class="st">"cluster"</span>)</span>
<span id="cb10-1226"><a href="#cb10-1226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1227"><a href="#cb10-1227" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Traits berechnen ---</span></span>
<span id="cb10-1228"><a href="#cb10-1228" aria-hidden="true" tabindex="-1"></a>  trait_df <span class="ot">&lt;-</span> <span class="fu">compute_traits_from_lad</span>(lad_profiles_long, res_z)</span>
<span id="cb10-1229"><a href="#cb10-1229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1230"><a href="#cb10-1230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Spatial Centroid für jede Cluster-ID ---</span></span>
<span id="cb10-1231"><a href="#cb10-1231" aria-hidden="true" tabindex="-1"></a>  cluster_points <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb10-1232"><a href="#cb10-1232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb10-1233"><a href="#cb10-1233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(X, Y), mean), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1234"><a href="#cb10-1234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ENVIMET_ID =</span> <span class="fu">paste0</span>(<span class="st">"S"</span>, <span class="fu">formatC</span>(cluster, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">flag =</span> <span class="st">"0"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb10-1235"><a href="#cb10-1235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="dv">25832</span>)</span>
<span id="cb10-1236"><a href="#cb10-1236" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1237"><a href="#cb10-1237" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Export .gpkg und .pld ---</span></span>
<span id="cb10-1238"><a href="#cb10-1238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(cluster_points, <span class="fu">file.path</span>(out_dir, <span class="st">"synthetic_envimet_profiles.gpkg"</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-1239"><a href="#cb10-1239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">export_lad_to_envimet_p3d</span>(lad_profiles_long, <span class="fu">file.path</span>(out_dir, <span class="st">"synthetic_envimet_profiles.pld"</span>),</span>
<span id="cb10-1240"><a href="#cb10-1240" aria-hidden="true" tabindex="-1"></a>                            <span class="at">res_z =</span> res_z, <span class="at">trait_df =</span> trait_df)</span>
<span id="cb10-1241"><a href="#cb10-1241" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-1242"><a href="#cb10-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1243"><a href="#cb10-1243" aria-hidden="true" tabindex="-1"></a><span class="co">#' Export microclimf-compatible profiles per cluster</span></span>
<span id="cb10-1244"><a href="#cb10-1244" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1245"><a href="#cb10-1245" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_df_clean Cleaned LAD data with coordinates and cluster ID</span></span>
<span id="cb10-1246"><a href="#cb10-1246" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param out_file Output GPKG path</span></span>
<span id="cb10-1247"><a href="#cb10-1247" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-1248"><a href="#cb10-1248" aria-hidden="true" tabindex="-1"></a>export_microclimf_profiles <span class="ot">&lt;-</span> <span class="cf">function</span>(lad_df_clean, <span class="at">out_file =</span> <span class="st">"data/microclimf/synthetic_microclimf_profiles.gpkg"</span>) {</span>
<span id="cb10-1249"><a href="#cb10-1249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(out_file), <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-1250"><a href="#cb10-1250" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1251"><a href="#cb10-1251" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mittelung aller nicht-Koordinaten nach Cluster</span></span>
<span id="cb10-1252"><a href="#cb10-1252" aria-hidden="true" tabindex="-1"></a>  mean_traits <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb10-1253"><a href="#cb10-1253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb10-1254"><a href="#cb10-1254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="sc">-</span><span class="fu">c</span>(X, Y), <span class="sc">~</span><span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb10-1255"><a href="#cb10-1255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1256"><a href="#cb10-1256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cluster-Zentroiden</span></span>
<span id="cb10-1257"><a href="#cb10-1257" aria-hidden="true" tabindex="-1"></a>  cluster_points <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb10-1258"><a href="#cb10-1258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb10-1259"><a href="#cb10-1259" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">c</span>(X, Y), mean), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb10-1260"><a href="#cb10-1260" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1261"><a href="#cb10-1261" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Zusammenfügen</span></span>
<span id="cb10-1262"><a href="#cb10-1262" aria-hidden="true" tabindex="-1"></a>  out_df <span class="ot">&lt;-</span> <span class="fu">left_join</span>(cluster_points, mean_traits, <span class="at">by =</span> <span class="st">"cluster"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-1263"><a href="#cb10-1263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="dv">25832</span>)</span>
<span id="cb10-1264"><a href="#cb10-1264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1265"><a href="#cb10-1265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(out_df, out_file, <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-1266"><a href="#cb10-1266" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-1267"><a href="#cb10-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-1268"><a href="#cb10-1268" aria-hidden="true" tabindex="-1"></a><span class="co">#' Export all original LAD point profiles to GeoPackage with full spatial attribution</span></span>
<span id="cb10-1269"><a href="#cb10-1269" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-1270"><a href="#cb10-1270" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param lad_df_clean DataFrame with cleaned LAD columns and traits</span></span>
<span id="cb10-1271"><a href="#cb10-1271" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param out_gpkg Path to output .gpkg file</span></span>
<span id="cb10-1272"><a href="#cb10-1272" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param layer_name Layer name inside the GPKG</span></span>
<span id="cb10-1273"><a href="#cb10-1273" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Writes .gpkg file to disk</span></span>
<span id="cb10-1274"><a href="#cb10-1274" aria-hidden="true" tabindex="-1"></a>export_full_lad_profiles_gpkg <span class="ot">&lt;-</span> <span class="cf">function</span>(lad_df_clean, <span class="at">out_gpkg =</span> <span class="st">"data/lad_profiles_full.gpkg"</span>, <span class="at">layer_name =</span> <span class="st">"lad_profiles"</span>) {</span>
<span id="cb10-1275"><a href="#cb10-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>) <span class="sc">%in%</span> <span class="fu">colnames</span>(lad_df_clean)))</span>
<span id="cb10-1276"><a href="#cb10-1276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1277"><a href="#cb10-1277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create sf object</span></span>
<span id="cb10-1278"><a href="#cb10-1278" aria-hidden="true" tabindex="-1"></a>  sf_points <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(lad_df_clean, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="dv">25832</span>)  <span class="co"># EPSG 25832 = UTM Zone 32N</span></span>
<span id="cb10-1279"><a href="#cb10-1279" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-1280"><a href="#cb10-1280" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write to GPKG</span></span>
<span id="cb10-1281"><a href="#cb10-1281" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_write</span>(sf_points, out_gpkg, <span class="at">layer =</span> layer_name, <span class="at">delete_layer =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-1282"><a href="#cb10-1282" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="main-pipeline-from-microclimate_als_tc_v4.r" class="level2">
<h2 class="anchored" data-anchor-id="main-pipeline-from-microclimate_als_tc_v4.r">Main pipeline from <code>microclimate_ALS_tc_v4.R</code></h2>
<pre><code>Warning in readLines("../src/microclimate_ALS_tc_v4.R"): incomplete final line
found on '../src/microclimate_ALS_tc_v4.R'</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#' --- ENVI-met 3DPLANT column generator from voxelized ALS data ---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' Full pipeline from ALS voxelization to XML export for ENVI-met 3DPLANT.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Includes normalization, topographic metrics, LAD calculation, clustering, and XML writing.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># === Load Libraries ===</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lidR)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(XML)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stats)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rprojroot)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tools)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RANN)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(clusternomics)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(e1071)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(entropy)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(NbClust)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(matrixStats)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># === Configuration ===</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(<span class="st">"agriculture"</span>, <span class="st">"alder"</span>, <span class="st">"ash"</span>, <span class="st">"beech"</span>, <span class="st">"douglas_fir"</span>, <span class="st">"larch"</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"oak"</span>, <span class="st">"pastures"</span>, <span class="st">"roads"</span>, <span class="st">"settlements"</span>, <span class="st">"spruce"</span>, <span class="st">"water"</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>valid_species <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"alder"</span>, <span class="st">"ash"</span>, <span class="st">"beech"</span>, <span class="st">"douglas_fir"</span>, <span class="st">"larch"</span>, <span class="st">"oak"</span>, <span class="st">"spruce"</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>valid_ids <span class="ot">&lt;-</span> ts<span class="sc">$</span>ID[ts<span class="sc">$</span>value <span class="sc">%in%</span> valid_species]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>plant_prefix<span class="ot">=</span><span class="st">"SYN"</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>visualize <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>las_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/ALS/tiles/"</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>res_xy <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>res_z <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>scale_factor <span class="ot">&lt;-</span> <span class="fl">1.2</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>crs_code <span class="ot">&lt;-</span> <span class="dv">25832</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>output_gpkg <span class="ot">&lt;-</span> <span class="st">"data/envimet/envimet_p3dtree_points.gpkg"</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>xml_output_file <span class="ot">&lt;-</span> <span class="st">"data/envimet/als_envimet_trees.pld"</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>species_raster <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/aerial/treespecies_cleaned.tif"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"data/output"</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"src/new_utils.R"</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: LAS Merging and Normalization ===</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>las_fn <span class="ot">&lt;-</span> <span class="fu">merge_las_tiles</span>(las_file, <span class="st">"data/ALS/merged_output.laz"</span>, <span class="at">chunk_size =</span> <span class="dv">10000</span>, <span class="at">workers =</span> <span class="dv">6</span>)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">readLAS</span>(las_fn)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="fu">crs</span>(las) <span class="ot">&lt;-</span> <span class="st">"EPSG:25832"</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Ground Classification and DEM/CHM Generation ===</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="co"># ⚠ MEMORY: large point cloud + rasters</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>chm_pre <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(las, <span class="at">res =</span> res_xy, <span class="at">algorithm =</span> <span class="fu">pitfree</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">9</span>,<span class="dv">12</span>,<span class="dv">16</span>)))</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>rugosity <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">focal</span>(chm_pre, <span class="at">w =</span> <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>), <span class="at">fun =</span> sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>mean_rug <span class="ot">&lt;-</span> <span class="fu">global</span>(rugosity, <span class="at">fun =</span> <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>csf_params <span class="ot">&lt;-</span> <span class="cf">if</span> (mean_rug <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Detected complex/dense canopy – using fine CSF settings"</span>)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">csf</span>(<span class="at">cloth_resolution =</span> <span class="fl">0.5</span>, <span class="at">rigidness =</span> <span class="dv">2</span>, <span class="at">class_threshold =</span> <span class="fl">0.4</span>, <span class="at">iterations =</span> <span class="dv">800</span>)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Detected open canopy – using coarse CSF settings"</span>)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">csf</span>(<span class="at">cloth_resolution =</span> <span class="fl">1.5</span>, <span class="at">rigidness =</span> <span class="dv">4</span>, <span class="at">class_threshold =</span> <span class="fl">0.6</span>, <span class="at">iterations =</span> <span class="dv">300</span>)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>las <span class="ot">&lt;-</span> <span class="fu">classify_ground</span>(las, csf_params)</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>dem_algo <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> <span class="fu">recommend_dem_interpolation</span>(las, res_xy)))</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>dem <span class="ot">&lt;-</span> <span class="fu">rasterize_terrain</span>(las, <span class="at">res =</span> res_xy, <span class="at">algorithm =</span> dem_algo)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>dsm <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(las, <span class="at">res =</span> res_xy, <span class="at">algorithm =</span> <span class="fu">p2r</span>())</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>las_norm <span class="ot">&lt;-</span> <span class="fu">normalize_height</span>(las, <span class="at">algorithm =</span> <span class="fu">knnidw</span>(<span class="at">k =</span> <span class="dv">6</span>L, <span class="at">p =</span> <span class="dv">2</span>))</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ Free original LAS</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="co">#las &lt;- NULL; gc()</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: CHM + DSM + Topographic Metrics ===</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>pit_algo <span class="ot">&lt;-</span> <span class="fu">pitfree</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">16</span>))</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>chm <span class="ot">&lt;-</span> <span class="fu">rasterize_canopy</span>(las_norm, <span class="at">res =</span> res_xy, <span class="at">algorithm =</span> pit_algo)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">terrain</span>(dem, <span class="st">"slope"</span>, <span class="at">unit =</span> <span class="st">"radians"</span>)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>aspect <span class="ot">&lt;-</span> <span class="fu">terrain</span>(dem, <span class="st">"aspect"</span>, <span class="at">unit =</span> <span class="st">"degrees"</span>)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>TPI <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">focal</span>(<span class="fu">terrain</span>(dsm, <span class="st">"TPI"</span>), <span class="at">w =</span> <span class="fu">matrix</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">fun =</span> mean)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>TPI[TPI <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>; TPI[TPI <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>topo <span class="ot">&lt;-</span> <span class="fu">c</span>(dem, dsm, chm, slope, aspect, TPI)</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(topo) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"dem"</span>, <span class="st">"dsm"</span>, <span class="st">"chm"</span>, <span class="st">"slope"</span>, <span class="st">"aspect"</span>, <span class="st">"TPI"</span>)</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(topo, <span class="st">"data/ALS/topo_stack.tif"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(topo)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Voxelization + LAD ===</span></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="co"># ⚠ MEMORY: voxel and LAD matrices can be huge</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>voxels <span class="ot">&lt;-</span> <span class="fu">preprocess_voxels</span>(las_norm, res_xy, res_z)</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>lad_df <span class="ot">&lt;-</span> <span class="fu">convert_to_LAD_beer</span>(voxels, <span class="at">grainsize =</span> res_z, <span class="at">k =</span> k, <span class="at">scale_factor =</span> scale_factor)</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(voxels,<span class="st">"data/voxels.rds"</span>)</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ Free voxelized LAS</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="co">#las_norm &lt;- NULL; voxels &lt;- NULL; gc()</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Compute structural indices ===</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Only keep numeric LAD columns</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>lad_matrix <span class="ot">&lt;-</span> <span class="fu">select</span>(lad_df, <span class="fu">starts_with</span>(<span class="st">"lad_"</span>)) <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>()</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(lad_matrix) <span class="ot">&lt;-</span> <span class="fu">paste</span>(lad_df<span class="sc">$</span>X, lad_df<span class="sc">$</span>Y, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="co"># More efficient summary statistics</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_mean        <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowMeans2</span>(lad_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_max         <span class="ot">&lt;-</span> matrixStats<span class="sc">::</span><span class="fu">rowMaxs</span>(lad_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_height_max  <span class="ot">&lt;-</span> <span class="fu">max.col</span>(lad_matrix, <span class="at">ties.method =</span> <span class="st">"first"</span>) <span class="sc">*</span> res_z</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Skewness, kurtosis, entropy — still using apply (no native rowSkewness etc.)</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_skewness    <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_matrix, <span class="dv">1</span>, skewness)</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_kurtosis    <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_matrix, <span class="dv">1</span>, kurtosis)</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_entropy     <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_matrix, <span class="dv">1</span>, entropy)</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Ecological indices ===</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>n_layers <span class="ot">&lt;-</span> <span class="fu">ncol</span>(lad_matrix)</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>top_third <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">ceiling</span>(<span class="dv">2</span> <span class="sc">*</span> n_layers <span class="sc">/</span> <span class="dv">3</span>), n_layers)</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>Gap_Fraction <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(lad_matrix <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>Canopy_Cover_Top <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(lad_matrix[, top_third] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>LAD_CV <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_matrix, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Vertical evenness</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>lad_sums <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(lad_matrix, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>Vertical_Evenness <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(lad_matrix)), <span class="cf">function</span>(i) {</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> lad_matrix[i, ] <span class="sc">/</span> lad_sums[i]</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p[p <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">sum</span>(p <span class="sc">*</span> <span class="fu">log</span>(p)) <span class="sc">/</span> <span class="fu">log</span>(<span class="fu">length</span>(p))</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ Remove LAD matrix if done</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Add topographic &amp; species data ===</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>topo_stack <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"data/ALS/topo_stack.tif"</span>)</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Erzeuge ein sf-Objekt aus lad_df</span></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>sf_lad <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(<span class="fu">as.data.frame</span>(lad_df), <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> crs_code)</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>geom_only <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(sf_lad)</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>elev   <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>( topo_stack[[<span class="st">"dem"</span>]], <span class="fu">st_buffer</span>(geom_only, <span class="at">dist =</span> <span class="fl">0.1</span>), <span class="st">"mean"</span>)</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>slope  <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>( topo_stack[[<span class="st">"slope"</span>]], <span class="fu">st_buffer</span>(geom_only, <span class="at">dist =</span> <span class="fl">0.1</span>), <span class="st">"mean"</span>)</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>aspect <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>( topo_stack[[<span class="st">"aspect"</span>]], <span class="fu">st_buffer</span>(geom_only, <span class="at">dist =</span> <span class="fl">0.1</span>), <span class="st">"mean"</span>)</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>TPI    <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>( topo_stack[[<span class="st">"TPI"</span>]], <span class="fu">st_buffer</span>(geom_only, <span class="at">dist =</span> <span class="fl">0.1</span>), <span class="st">"mean"</span>)</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>CHM    <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>( topo_stack[[<span class="st">"chm"</span>]], <span class="fu">st_buffer</span>(geom_only, <span class="at">dist =</span> <span class="fl">0.1</span>), <span class="st">"mean"</span>)</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>lad_df<span class="sc">$</span>species_class <span class="ot">&lt;-</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>( species_raster, <span class="fu">st_buffer</span>(geom_only, <span class="at">dist =</span> <span class="fl">0.1</span>), <span class="st">"mean"</span>)</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(lad_df,<span class="st">"data/lad_df.rds"</span>)</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a><span class="co"># ✅ Remove sf and stack</span></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="co">#sf_lad &lt;- NULL; topo_stack &lt;- NULL;geom_only=NULL; gc()</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Combine data for clustering ===</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>lad_matrix <span class="ot">&lt;-</span> lad_df <span class="sc">%&gt;%</span></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"lad_pulses_"</span>), <span class="fu">starts_with</span>(<span class="st">"LAD_"</span>),LAD_skewness,LAD_kurtosis,LAD_CV ,LAD_entropy , Vertical_Evenness) <span class="sc">%&gt;%</span></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(lad_matrix) <span class="ot">&lt;-</span> <span class="fu">paste</span>(lad_df<span class="sc">$</span>X, lad_df<span class="sc">$</span>Y, <span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: Filter for valid species and complete rows ===</span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>valid_idx <span class="ot">&lt;-</span> lad_df<span class="sc">$</span>species_class <span class="sc">%in%</span> valid_ids</span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>lad_df <span class="ot">&lt;-</span> lad_df[valid_idx, ]</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>lad_matrix <span class="ot">&lt;-</span> lad_matrix[valid_idx, ]</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>pulse_cols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"^lad_pulses_"</span>, <span class="fu">colnames</span>(lad_matrix), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>lad_pulses <span class="ot">&lt;-</span> lad_matrix[, pulse_cols]</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter valid rows for clustering</span></span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>valid_rows <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_pulses, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">all</span>(<span class="fu">is.finite</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>lad_pulses <span class="ot">&lt;-</span> lad_pulses[valid_rows, ]</span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>lad_df <span class="ot">&lt;-</span> lad_df[valid_rows, ]</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a><span class="co"># === ⬛ STAGE: PCA sampling + NbClust ===</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>sample_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(lad_pulses)), <span class="fu">floor</span>(<span class="fu">nrow</span>(lad_pulses) <span class="sc">*</span> <span class="fl">0.01</span>))</span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> lad_pulses[sample_idx, ]</span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size before NA filtering:"</span>, <span class="fu">nrow</span>(sample_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a>keep_cols <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colMeans</span>(<span class="fu">is.na</span>(sample_data)) <span class="sc">&lt;=</span> <span class="fl">0.2</span>)</span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> sample_data[, keep_cols]</span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> sample_data[, <span class="fu">apply</span>(sample_data, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="fl">1e-10</span>]</span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>sample_data <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(sample_data)</span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample size after cleaning:"</span>, <span class="fu">nrow</span>(sample_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a><span class="co"># ⚠ MEMORY: PCA and NbClust can explode RAM use</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>pca_res <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(sample_data, <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>pc_info <span class="ot">&lt;-</span> <span class="fu">suggest_n_pcs</span>(pca_res, <span class="at">variance_cutoff =</span> <span class="fl">0.9</span>)</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>sample_data_pca <span class="ot">&lt;-</span> pca_res<span class="sc">$</span>x[, <span class="dv">1</span><span class="sc">:</span>pc_info<span class="sc">$</span>n_pcs]</span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="fu">NbClust</span>(sample_data_pca, <span class="at">distance =</span> <span class="st">"euclidean"</span>, <span class="at">min.nc =</span> <span class="dv">2</span>, <span class="at">max.nc =</span> <span class="dv">30</span>, <span class="at">method =</span> <span class="st">"kmeans"</span>)</span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>optimal_k <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">names</span>(<span class="fu">which.max</span>(<span class="fu">table</span>(nb<span class="sc">$</span>Best.nc[<span class="dv">1</span>, ]))))</span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Best number of clusters</span></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🔢 Best number of clusters (Best.nc):"</span>, optimal_k, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Bereinige ungültige Zeilen für Clustering ---</span></span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>        valid_rows <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_pulses, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">all</span>(<span class="fu">is.finite</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a>        lad_pulses <span class="ot">&lt;-</span> lad_pulses[valid_rows, ]</span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a>        valid_rows <span class="ot">&lt;-</span> <span class="fu">apply</span>(lad_df, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">all</span>(<span class="fu">is.finite</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>        lad_df_clean <span class="ot">&lt;-</span> lad_df[valid_rows, ]</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Clustering-Spalten selektieren</span></span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>        lad_dftocluster <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"lad_pulses_"</span>),</span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">starts_with</span>(<span class="st">"LAD_"</span>),</span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>                 LAD_skewness, LAD_kurtosis, LAD_CV, LAD_entropy, Vertical_Evenness) <span class="sc">%&gt;%</span></span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">&lt;=</span> <span class="fl">2e-5</span>, <span class="dv">0</span>, .)))</span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>        <span class="co">#lad_df &lt;- lad_df[valid_rows, ]</span></span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>        lad_features <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"lad_pulses_"</span>), <span class="fu">starts_with</span>(<span class="st">"LAD_"</span>), LAD_skewness, LAD_kurtosis, LAD_CV, LAD_entropy, Vertical_Evenness) <span class="sc">%&gt;%</span></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">&lt;=</span> <span class="fl">2e-5</span>, <span class="dv">0</span>, .)))   </span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entferne leere Zeilen</span></span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>        lad_dftocluster <span class="ot">&lt;-</span> lad_dftocluster[<span class="fu">rowSums</span>(lad_dftocluster <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">3</span>, ]</span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>        lad_dftocluster_scaled <span class="ot">&lt;-</span> <span class="fu">scale</span>(lad_dftocluster)</span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Clustering (KMeans_arma von ClusterR) ---</span></span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>km_arma <span class="ot">&lt;-</span> ClusterR<span class="sc">::</span><span class="fu">KMeans_arma</span>(</span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> lad_dftocluster,</span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">clusters =</span> optimal_k,</span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_iter =</span> <span class="dv">100</span>,</span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed_mode =</span> <span class="st">"random_subset"</span></span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Cluster-Zuweisung berechnen ---</span></span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>lad_df_clean<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(</span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>  ClusterR<span class="sc">::</span><span class="fu">predict_KMeans</span>(</span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> lad_dftocluster,</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>km_arma</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a><span class="co"># Schritt 1: Synthetische Mittelprofile erzeugen (alle LADs mitteln je Cluster)</span></span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>cluster_profiles <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">"lad_"</span>), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a><span class="co"># Schritt 2: Eindeutige ENVIMET_ID je Cluster erzeugen</span></span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a>cluster_profiles <span class="ot">&lt;-</span> cluster_profiles <span class="sc">%&gt;%</span></span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ENVIMET_ID =</span> <span class="fu">paste0</span>(plant_prefix, <span class="fu">formatC</span>(cluster, <span class="at">width =</span> <span class="dv">3</span>, <span class="at">flag =</span> <span class="st">"0"</span>)))</span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a><span class="co"># Schritt 3: ID zurück an alle Originalpunkte hängen</span></span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a>lad_df_clean <span class="ot">&lt;-</span> lad_df_clean <span class="sc">%&gt;%</span></span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cluster_profiles <span class="sc">%&gt;%</span> <span class="fu">select</span>(cluster, ENVIMET_ID), <span class="at">by =</span> <span class="st">"cluster"</span>)</span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ENVI-met exportieren</span></span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a>        <span class="fu">export_envimet_profiles</span>(</span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a>          <span class="at">lad_df_clean =</span> lad_df_clean,</span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a>          <span class="at">res_z =</span> <span class="dv">1</span>  <span class="co"># oder 2 – je nachdem, wie deine Voxelhöhe lautet</span></span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># microclimf Input exportieren</span></span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a>        <span class="fu">export_microclimf_profiles</span>(</span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a>          <span class="at">lad_df_clean =</span> lad_df_clean</span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a>     <span class="fu">export_full_lad_profiles_gpkg</span>(</span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a>          <span class="at">lad_df_clean =</span> lad_df_clean,</span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a>          <span class="at">out_gpkg =</span> <span class="st">"data/lad_profiles_full.gpkg"</span>,</span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a>          <span class="at">layer_name =</span> <span class="st">"lad_profiles"</span></span>
<span id="cb12-266"><a href="#cb12-266" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-267"><a href="#cb12-267" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Plot spatial distribution of clusters (optional diagnostics) ---</span></span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (visualize) {</span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a>          <span class="fu">library</span>(ggplot2)</span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ggplot</span>(lad_df, <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> Y, <span class="at">color =</span> <span class="fu">as.factor</span>(cluster))) <span class="sc">+</span></span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_color_viridis_d</span>(<span class="at">name =</span> <span class="st">"Cluster"</span>) <span class="sc">+</span></span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Spatial distribution of LAD clusters"</span>) <span class="sc">+</span></span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_minimal</span>()</span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-278"><a href="#cb12-278" aria-hidden="true" tabindex="-1"></a>         </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="gisma-courses/TLS-tree-climate" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../doc/tls_v1_2.html" class="pagination-link" aria-label="Using leaf area density (LAD) from TLS data in ENVI-met for 3D plants">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Using leaf area density (LAD) from TLS data in ENVI-met for 3D plants</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../doc/new_utils2.html" class="pagination-link" aria-label="Function &amp; Workflow Reference: LAD and ALS Processing">
        <span class="nav-page-text">Function &amp; Workflow Reference: LAD and ALS Processing</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>TLS-tree-climate (2025)</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/gisma-courses/TLS-tree-climate/edit/main/doc/microclimate_ALS_tc_v4.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/gisma-courses/TLS-tree-climate/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>